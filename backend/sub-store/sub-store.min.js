const $=API("sub-store"),Base64=new Base64Code;function service(){console.log("\nâ”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…\n            ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† Â© ğ‘·ğ’†ğ’ğ’ˆ-ğ’€ğ‘´\nâ”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…\n");const $app=express(),SETTINGS_KEY="settings",SUBS_KEY="subs",COLLECTIONS_KEY="collections",RULES_KEY="rules",BUILT_IN_KEY="builtin",ARTIFACTS_KEY="artifacts",GIST_BACKUP_KEY="Auto Generated Sub-Store Backup",GIST_BACKUP_FILE_NAME="Sub-Store",ARTIFACT_REPOSITORY_KEY="Sub-Store Artifacts Repository";async function downloadSubscription(req,res){const{name:name}=req.params,{cache:cache}=req.query,{raw:raw}=req.query||"false",platform=req.query.target||getPlatformFromHeaders(req.headers)||"JSON",useCache=void 0===cache?"JSON"===platform||"URI"===platform:cache;$.info(`æ­£åœ¨ä¸‹è½½è®¢é˜…ï¼š${name}`);const allSubs=$.read("subs"),sub=allSubs[name];if(sub)try{const output=await produceArtifact({type:"subscription",item:sub,platform:platform,useCache:useCache,noProcessor:raw});if(-1!==["QX","Surge","Loon"].indexOf(getPlatformFromHeaders(req.headers))){const{headers:headers}=await $.http.get({url:sub.url,headers:{"User-Agent":"Quantumult/1.0.13 (iPhone10,3; iOS 14.0)"}}),subkey=Object.keys(headers).filter(k=>/SUBSCRIPTION-USERINFO/i.test(k))[0],userinfo=headers[subkey];res.set("subscription-userinfo",userinfo)}"JSON"===platform?res.set("Content-Type","application/json;charset=utf-8").send(output):res.send(output)}catch(err){$.notify("ğŸŒ ã€ ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† ã€ ä¸‹è½½è®¢é˜…å¤±è´¥",`âŒ æ— æ³•ä¸‹è½½è®¢é˜…ï¼š${name}ï¼`,`ğŸ¤” åŸå› ï¼š${err}`),res.status(500).json({status:"failed",message:err})}else $.notify("ğŸŒ ã€ ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† ã€ ä¸‹è½½è®¢é˜…å¤±è´¥",`âŒ æœªæ‰¾åˆ°è®¢é˜…ï¼š${name}ï¼`),res.status(404).json({status:"failed"})}function createSubscription(req,res){const sub=req.body,allSubs=$.read("subs");$.info(`æ­£åœ¨åˆ›å»ºè®¢é˜…ï¼š ${sub.name}`),allSubs[sub.name]&&res.status(500).json({status:"failed",message:`è®¢é˜…${sub.name}å·²å­˜åœ¨ï¼`}),/^[\w-_]*$/.test(sub.name)?(allSubs[sub.name]=sub,$.write(allSubs,"subs"),res.status(201).json({status:"success",data:sub})):res.status(500).json({status:"failed",message:`è®¢é˜…åç§° ${sub.name} ä¸­å«æœ‰éæ³•å­—ç¬¦ï¼åç§°ä¸­åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€æ¨ªæ ã€‚`})}function getSubscription(req,res){const{name:name}=req.params,sub=$.read("subs")[name];sub?res.json({status:"success",data:sub}):res.status(404).json({status:"failed",message:`æœªæ‰¾åˆ°è®¢é˜…ï¼š${name}!`})}function updateSubscription(req,res){const{name:name}=req.params;let sub=req.body;const allSubs=$.read("subs");if(allSubs[name]){const newSub={...allSubs[name],...sub};if($.info(`æ­£åœ¨æ›´æ–°è®¢é˜…ï¼š ${name}`),name!==sub.name){const allCols=$.read("collections");for(const k of Object.keys(allCols)){const idx=allCols[k].subscriptions.indexOf(name);-1!==idx&&(allCols[k].subscriptions[idx]=sub.name)}delete allSubs[name],allSubs[sub.name]=newSub}else allSubs[name]=newSub;$.write(allSubs,"subs"),res.json({status:"success",data:newSub})}else res.status(500).json({status:"failed",message:`è®¢é˜…${name}ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°ï¼`})}function deleteSubscription(req,res){const{name:name}=req.params;$.info(`åˆ é™¤è®¢é˜…ï¼š${name}...`);let allSubs=$.read("subs");delete allSubs[name],$.write(allSubs,"subs");let allCols=$.read("collections");for(const k of Object.keys(allCols))allCols[k].subscriptions=allCols[k].subscriptions.filter(s=>s!==name);$.write(allCols,"collections"),res.json({status:"success"})}function getAllSubscriptions(req,res){const allSubs=$.read("subs");res.json({status:"success",data:allSubs})}async function downloadCollection(req,res){const{name:name}=req.params,{cache:cache}=req.query||"false",{raw:raw}=req.query||"false",platform=req.query.target||getPlatformFromHeaders(req.headers)||"JSON",useCache=void 0===cache?"JSON"===platform||"URI"===platform:cache,allCollections=$.read("collections"),collection=allCollections[name];if($.info(`æ­£åœ¨ä¸‹è½½ç»„åˆè®¢é˜…ï¼š${name}`),collection)try{const output=await produceArtifact({type:"collection",item:collection,platform:platform,useCache:useCache,noProcessor:raw});"JSON"===platform?res.set("Content-Type","application/json;charset=utf-8").send(output):res.send(output)}catch(err){$.notify("ğŸŒ ã€ ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† ã€ ä¸‹è½½ç»„åˆè®¢é˜…å¤±è´¥",`âŒ ä¸‹è½½ç»„åˆè®¢é˜…é”™è¯¯ï¼š${name}ï¼`,`ğŸ¤” åŸå› ï¼š${err}`),res.status(500).json({status:"failed",message:err})}else $.notify("ğŸŒ ã€ ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† ã€ ä¸‹è½½ç»„åˆè®¢é˜…å¤±è´¥",`âŒ æœªæ‰¾åˆ°ç»„åˆè®¢é˜…ï¼š${name}ï¼`),res.status(404).json({status:"failed"})}function createCollection(req,res){const collection=req.body;$.info(`æ­£åœ¨åˆ›å»ºç»„åˆè®¢é˜…ï¼š${collection.name}`);const allCol=$.read("collections");allCol[collection.name]&&res.status(500).json({status:"failed",message:`è®¢é˜…é›†${collection.name}å·²å­˜åœ¨ï¼`}),/^[\w-_]*$/.test(collection.name)?(allCol[collection.name]=collection,$.write(allCol,"collections"),res.status(201).json({status:"success",data:collection})):res.status(500).json({status:"failed",message:`è®¢é˜…é›†åç§° ${collection.name} ä¸­å«æœ‰éæ³•å­—ç¬¦ï¼åç§°ä¸­åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€æ¨ªæ ã€‚`})}function getCollection(req,res){const{name:name}=req.params,collection=$.read("collections")[name];collection?res.json({status:"success",data:collection}):res.status(404).json({status:"failed",message:`æœªæ‰¾åˆ°è®¢é˜…é›†ï¼š${name}!`})}function updateCollection(req,res){const{name:name}=req.params;let collection=req.body;const allCol=$.read("collections");if(allCol[name]){const newCol={...allCol[name],...collection};$.info(`æ­£åœ¨æ›´æ–°ç»„åˆè®¢é˜…ï¼š${name}...`),delete allCol[name],allCol[collection.name||name]=newCol,$.write(allCol,"collections"),res.json({status:"success",data:newCol})}else res.status(500).json({status:"failed",message:`è®¢é˜…é›†${name}ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°ï¼`})}function deleteCollection(req,res){const{name:name}=req.params;$.info(`æ­£åœ¨åˆ é™¤ç»„åˆè®¢é˜…ï¼š${name}`);let allCol=$.read("collections");delete allCol[name],$.write(allCol,"collections"),res.json({status:"success"})}function getAllCollections(req,res){const allCols=$.read("collections");res.json({status:"success",data:allCols})}async function downloadRule(req,res){const{name:name}=req.params,{builtin:builtin}=req.query,platform=req.query.target||getPlatformFromHeaders(req.headers)||"Surge";let rule;if($.info(`æ­£åœ¨ä¸‹è½½${builtin?"å†…ç½®":""}åˆ†æµè®¢é˜…ï¼š${name}...`),builtin&&(rule=$.read("builtin").rules[name]),rule){const output=await produceArtifact({type:"rule",item:rule,platform:platform});res.send(output)}else $.notify("ğŸŒ ã€ ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† ã€ ä¸‹è½½åˆ†æµè®¢é˜…å¤±è´¥",`âŒ æœªæ‰¾åˆ°åˆ†æµè®¢é˜…ï¼š${name}ï¼`),res.status(404).json({status:"failed"})}function createRule(req,res){}function deleteRule(req,res){}function updateRule(req,res){}function getAllRules(req,res){}function getRule(req,res){}function getSettings(req,res){const settings=$.read("settings");res.json(settings)}function updateSettings(req,res){const data=req.body,settings=$.read("settings");$.write({...settings,...data},"settings"),res.json({status:"success"})}async function getArtifact(req,res){const name=req.params.name,action=req.query.action,allArtifacts=$.read("artifacts"),artifact=allArtifacts[name];if(artifact)if(action){let item;switch(artifact.type){case"subscription":item=$.read("subs")[artifact.source];break;case"collection":item=$.read("collections")[artifact.source];break;case"rule":item=$.read("rules")[artifact.source]}const output=await produceArtifact({type:artifact.type,item:item,platform:artifact.platform});if("preview"===action)res.send(output);else if("sync"===action){$.info(`æ­£åœ¨ä¸Šä¼ é…ç½®ï¼š${artifact.name}\n>>>`),console.log(JSON.stringify(artifact,null,2));try{const resp=await syncArtifact({filename:artifact.name,content:output});artifact.updated=(new Date).getTime();const body=JSON.parse(resp.body);artifact.url=body.files[artifact.name].raw_url.replace(/\/raw\/[^\/]*\/(.*)/,"/raw/$1"),$.write(allArtifacts,"artifacts"),res.json({status:"success"})}catch(err){res.status(500).json({status:"failed",message:err})}}}else res.json({status:"success",data:artifact});else res.status(404).json({status:"failed",message:"æœªæ‰¾åˆ°å¯¹åº”çš„é…ç½®ï¼"})}function createArtifact(req,res){const artifact=req.body;$.info(`æ­£åœ¨åˆ›å»ºè¿œç¨‹é…ç½®ï¼š${artifact.name}`);const allArtifacts=$.read("artifacts");allArtifacts[artifact.name]?res.status(500).json({status:"failed",message:`è¿œç¨‹é…ç½®${artifact.name}å·²å­˜åœ¨ï¼`}):/^[\w-_.]*$/.test(artifact.name)?(allArtifacts[artifact.name]=artifact,$.write(allArtifacts,"artifacts"),res.status(201).json({status:"success",data:artifact})):res.status(500).json({status:"failed",message:`è¿œç¨‹é…ç½®åç§° ${artifact.name} ä¸­å«æœ‰éæ³•å­—ç¬¦ï¼åç§°ä¸­åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€æ¨ªæ ã€‚`})}function updateArtifact(req,res){const allArtifacts=$.read("artifacts"),oldName=req.params.name,artifact=allArtifacts[oldName];if(artifact){$.info(`æ­£åœ¨æ›´æ–°è¿œç¨‹é…ç½®ï¼š${artifact.name}`);const newArtifact=req.body;if(void 0===newArtifact.name||/^[\w-_.]*$/.test(newArtifact.name)){const merged={...artifact,...newArtifact};allArtifacts[merged.name]=merged,merged.name!==oldName&&delete allArtifacts[oldName],$.write(allArtifacts,"artifacts"),res.json({status:"success",data:merged})}else res.status(500).json({status:"failed",message:`è¿œç¨‹é…ç½®åç§° ${newArtifact.name} ä¸­å«æœ‰éæ³•å­—ç¬¦ï¼åç§°ä¸­åªèƒ½åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€æ¨ªæ ã€‚`})}else res.status(404).json({status:"failed",message:"æœªæ‰¾åˆ°å¯¹åº”çš„è¿œç¨‹é…ç½®ï¼"})}async function cronSyncArtifacts(req,res){$.info("å¼€å§‹åŒæ­¥æ‰€æœ‰è¿œç¨‹é…ç½®...");const allArtifacts=$.read("artifacts");let success=[],failed=[];for(const artifact of Object.values(allArtifacts))if(artifact.sync){$.info(`æ­£åœ¨åŒæ­¥äº‘é…ç½®ï¼š${artifact.name}...`);try{let item;switch(artifact.type){case"subscription":item=$.read("subs")[artifact.source];break;case"collection":item=$.read("collections")[artifact.source];break;case"rule":item=$.read("rules")[artifact.source]}const output=await produceArtifact({type:artifact.type,item:item,platform:artifact.platform}),resp=await syncArtifact({filename:artifact.name,content:output});artifact.updated=(new Date).getTime();const body=JSON.parse(resp.body);artifact.url=body.files[artifact.name].raw_url.replace(/\/raw\/[^\/]*\/(.*)/,"/raw/$1"),$.write(allArtifacts,"artifacts"),$.info(`âœ… æˆåŠŸåŒæ­¥äº‘é…ç½®ï¼š${artifact.name}`),success.push(artifact)}catch(err){$.error(`äº‘é…ç½®: ${artifact.name} åŒæ­¥å¤±è´¥ï¼åŸå› ï¼š${err}`),$.notify("ğŸŒ ã€ ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† ã€ åŒæ­¥è®¢é˜…å¤±è´¥",`âŒ æ— æ³•åŒæ­¥è®¢é˜…ï¼š${artifact.name}ï¼`,`ğŸ¤” åŸå› ï¼š${err}`),failed.push(artifact)}}res.json({success:success,failed:failed})}async function deleteArtifact(req,res){const name=req.params.name;$.info(`æ­£åœ¨åˆ é™¤è¿œç¨‹é…ç½®ï¼š${name}`);const allArtifacts=$.read("artifacts");try{const artifact=allArtifacts[name];if(!artifact)throw new Error(`è¿œç¨‹é…ç½®ï¼š${name}ä¸å­˜åœ¨ï¼`);artifact.updated&&await syncArtifact({filename:name,content:""}),delete allArtifacts[name],$.write(allArtifacts,"artifacts"),res.json({status:"success"})}catch(err){delete allArtifacts[name],$.write(allArtifacts,"artifacts"),res.status(500).json({status:"failed",message:`æ— æ³•åˆ é™¤è¿œç¨‹é…ç½®ï¼š${name}, åŸå› ï¼š${err}`})}}function getAllArtifacts(req,res){const allArtifacts=$.read("artifacts");res.json({status:"success",data:allArtifacts})}async function syncArtifact({filename:filename,content:content}){const{gistToken:gistToken}=$.read("settings");if(!gistToken)return Promise.reject("æœªè®¾ç½®Gist Tokenï¼");const manager=new Gist({token:gistToken,key:ARTIFACT_REPOSITORY_KEY});return manager.upload({filename:filename,content:content})}async function IP_API(req,res){const server=decodeURIComponent(req.params.server),result=await $.http.get(`http://ip-api.com/json/${server}?lang=zh-CN`).then(resp=>JSON.parse(resp.body));res.json(result)}async function refreshCache(req,res){const{url:url}=req.body;$.info(`Refreshing cache for URL: ${url}`);try{const raw=await getResource(url,!1);$.write(raw,`#${Base64.safeEncode(url)}`),res.json({status:"success"})}catch(err){res.status(500).json({status:"failed",message:`æ— æ³•åˆ·æ–°èµ„æº ${url}ï¼š ${err}`})}}function getEnv(req,res){const{isNode:isNode,isQX:isQX,isLoon:isLoon,isSurge:isSurge}=ENV();let backend="Node";isNode&&(backend="Node"),isQX&&(backend="QX"),isLoon&&(backend="Loon"),isSurge&&(backend="Surge"),res.json({backend:backend})}async function gistBackup(req,res){const{action:action}=req.query,{gistToken:gistToken}=$.read("settings");if(gistToken){const gist=new Gist({token:gistToken,key:GIST_BACKUP_KEY});try{let content;switch(action){case"upload":const settings=$.read("settings");settings.syncTime=(new Date).getTime(),$.write(settings,"settings"),content=$.read("#sub-store"),$.info("ä¸Šä¼ å¤‡ä»½ä¸­..."),await gist.upload({filename:"Sub-Store",content:content});break;case"download":$.info("è¿˜åŸå¤‡ä»½ä¸­..."),content=await gist.download("Sub-Store"),$.write(content,"#sub-store")}res.json({status:"success"})}catch(err){const msg=`${"upload"===action?"ä¸Šä¼ ":"ä¸‹è½½"}å¤‡ä»½å¤±è´¥ï¼${err}`;$.error(msg),res.status(500).json({status:"failed",message:msg})}}else res.status(500).json({status:"failed",message:"æœªæ‰¾åˆ°Gistå¤‡ä»½Token!"})}function getPlatformFromHeaders(headers){const keys=Object.keys(headers);let UA="";for(let k of keys)if(/USER-AGENT/i.test(k)){UA=headers[k];break}return-1!==UA.indexOf("Quantumult%20X")?"QX":-1!==UA.indexOf("Surge")?"Surge":-1!==UA.indexOf("Decar")||-1!==UA.indexOf("Loon")?"Loon":null}async function getResource(url,useCache=!0){const $http=HTTP({headers:{"User-Agent":"Quantumult%20X"}}),key="#"+Base64.safeEncode(url),resource=$.read(key),timeKey=`#TIME-${Base64.safeEncode(url)}`,ONE_HOUR=36e5,outdated=(new Date).getTime()-$.read(timeKey)>36e5;if(useCache&&resource&&!outdated)return $.log(`Use cached for resource: ${url}`),resource;let body="";try{const resp=await $http.get(url);body=resp.body}catch(err){throw new Error(err)}finally{$.write(body,key),$.write((new Date).getTime(),timeKey)}if(0===body.replace(/\s/g,"").length)throw new Error("è®¢é˜…å†…å®¹ä¸ºç©ºï¼");return body}async function produceArtifact({type:type,item:item,platform:platform,useCache:useCache,noProcessor:noProcessor}={platform:"JSON",useCache:!1,noProcessor:!1}){if("subscription"===type){const sub=item,raw=await getResource(sub.url,useCache);let proxies=ProxyUtils.parse(raw);noProcessor||(proxies=await ProxyUtils.process(proxies,sub.process||[]));const count={};return proxies.forEach(p=>{count[p.name]&&$.notify("ğŸŒ ã€ ğ‘ºğ’–ğ’ƒ-ğ‘ºğ’•ğ’ğ’“ğ’† ã€","âš ï¸ è®¢é˜…åŒ…å«é‡å¤èŠ‚ç‚¹ï¼","è¯·ä»”ç»†æ£€æµ‹é…ç½®ï¼",{"media-url":"https://cdn3.iconfinder.com/data/icons/seo-outline-1/512/25_code_program_programming_develop_bug_search_developer-512.png"})}),ProxyUtils.produce(proxies,platform)}if("collection"===type){const allSubs=$.read("subs"),collection=item,subs=collection.subscriptions;let proxies=[];for(let i=0;i<subs.length;i++){const sub=allSubs[subs[i]];$.info(`æ­£åœ¨å¤„ç†å­è®¢é˜…ï¼š${sub.name}ï¼Œè¿›åº¦--${100*((i+1)/subs.length).toFixed(1)}% `);try{const raw=await getResource(sub.url,useCache);let currentProxies=ProxyUtils.parse(raw);noProcessor||(currentProxies=await ProxyUtils.process(currentProxies,sub.process||[])),proxies=proxies.concat(currentProxies)}catch(err){$.error(`å¤„ç†ç»„åˆè®¢é˜…ä¸­çš„å­è®¢é˜…: ${sub.name}æ—¶å‡ºç°é”™è¯¯ï¼š${err}! è¯¥è®¢é˜…å·²è¢«è·³è¿‡ã€‚`)}}if(noProcessor||(proxies=await ProxyUtils.process(proxies,collection.process||[])),0===proxies.length)throw new Error("ç»„åˆè®¢é˜…ä¸­ä¸å«æœ‰æ•ˆèŠ‚ç‚¹ï¼");return ProxyUtils.produce(proxies,platform)}if("rule"===type){const rule=item;let rules=[];for(let i=0;i<rule.urls.length;i++){const url=rule.urls[i];$.info(`æ­£åœ¨å¤„ç†URLï¼š${url}ï¼Œè¿›åº¦--${100*((i+1)/rule.urls.length).toFixed(1)}% `);try{const{body:body}=await $.http.get(url),currentRules=RuleUtils.parse(body);rules=rules.concat(currentRules)}catch(err){$.error(`å¤„ç†åˆ†æµè®¢é˜…ä¸­çš„URL: ${url}æ—¶å‡ºç°é”™è¯¯ï¼š${err}! è¯¥è®¢é˜…å·²è¢«è·³è¿‡ã€‚`)}}return rules=await RuleUtils.process(rules,[{type:"Remove Duplicate Filter"}]),RuleUtils.produce(rules,platform)}}$.read("subs")||$.write({},"subs"),$.read("collections")||$.write({},"collections"),$.read("settings")||$.write({},"settings"),$.read("rules")||$.write({},"rules"),$.read("artifacts")||$.write({},"artifacts"),$.write({rules:getBuiltInRules()},"builtin"),$app.get("/download/collection/:name",downloadCollection),$app.get("/download/:name",downloadSubscription),$app.route("/api/sub/:name").get(getSubscription).patch(updateSubscription).delete(deleteSubscription),$app.route("/api/subs").get(getAllSubscriptions).post(createSubscription),$app.get("/api/sub/statistics/:name"),$app.route("/api/collection/:name").get(getCollection).patch(updateCollection).delete(deleteCollection),$app.route("/api/collections").get(getAllCollections).post(createCollection),$app.get("/download/rule/:name",downloadRule),$app.route("/api/rules").post(createRule).get(getAllRules),$app.route("/api/rule/:name").patch(updateRule).delete(deleteRule).get(getRule),$app.route("/api/storage").get((req,res)=>{res.json($.read("#sub-store"))}).post((req,res)=>{const data=req.body;$.write(JSON.stringify(data),"#sub-store"),res.end()}),$app.route("/api/settings").get(getSettings).patch(updateSettings),$app.route("/api/artifacts").get(getAllArtifacts).post(createArtifact),$app.route("/api/artifact/:name").get(getArtifact).patch(updateArtifact).delete(deleteArtifact),$app.get("/api/utils/IP_API/:server",IP_API),$app.post("/api/utils/refresh",refreshCache),$app.get("/api/utils/env",getEnv),$app.get("/api/utils/backup",gistBackup),$app.get("/api/cron/sync-artifacts",cronSyncArtifacts),$app.get("/",async(req,res)=>{res.set("location","https://sub-store.vercel.app/").status(302).end()}),ENV().isQX&&$app.options("/",async(req,res)=>{res.status(200).end()}),$app.all("/",(req,res)=>{res.send("Hello from sub-store, made with â¤ï¸ by Peng-YM")}),$app.start()}service();var ProxyUtils=function(){const PROXY_PREPROCESSORS=function(){function HTML(){const name="HTML",test=raw=>/^<!DOCTYPE html>/.test(raw),parse=_=>"";return{name:name,test:test,parse:parse}}function Base64Encoded(){const name="Base64 Pre-processor",keys=["dm1lc3M","c3NyOi8v","dHJvamFu","c3M6Ly","c3NkOi8v","c2hhZG93","aHR0c"],test=function(raw){return keys.some(k=>-1!==raw.indexOf(k))},parse=function(raw){return raw=Base64.safeDecode(raw)};return{name:name,test:test,parse:parse}}function Clash(){const name="Clash Pre-processor",test=function(raw){return/proxies/.test(raw)},parse=function(raw){-1!==raw.indexOf("{")&&(raw=raw.replace(/    - /g,"  - ").replace(/:(?!\s)/g,": ").replace(/\,\"/g,', "').replace(/: {/g,": {,     ").replace(/, (\"?host|path|tls|mux|skip\"?)/g,",     $1").replace(/{name: /g,'{name: "').replace(/, server:/g,'", server:').replace(/{|}/g,"").replace(/,/g,"\n   ")),raw=-1===(raw=raw.replace(/  -\n.*name/g,"  - name").replace(/\$|\`/g,"").split("proxy-providers:")[0].split("proxy-groups:")[0].replace(/\"([\w-]+)\"\s*:/g,"$1:")).indexOf("proxies:")?"proxies:\n"+raw:"proxies:"+raw.split("proxies:")[1];const proxies=YAML.eval(raw).proxies;return proxies.map(p=>JSON.stringify(p)).join("\n")};return{name:name,test:test,parse:parse}}function SSD(){const name="SSD Pre-processor",test=function(raw){return 0===raw.indexOf("ssd://")},parse=function(raw){const output=[];let ssdinfo=JSON.parse(Base64.safeDecode(raw.split("ssd://")[1]));const traffic_used=ssdinfo.traffic_used,traffic_total=ssdinfo.traffic_total,expiry=ssdinfo.expiry;let name=ssdinfo.airport,port=ssdinfo.port,method=ssdinfo.encryption,password=ssdinfo.password,servers=ssdinfo.servers;for(let i=0;i<servers.length;i++){let server=servers[i];method=server.encryption?server.encryption:method,password=server.password?server.password:password;let userinfo=Base64.safeEncode(method+":"+password),hostname=server.server;port=server.port?server.port:port;let tag=server.remarks?server.remarks:i,plugin=server.plugin_options?"/?plugin="+encodeURIComponent(server.plugin+";"+server.plugin_options):"";output[i]="ss://"+userinfo+"@"+hostname+":"+port+plugin+"#"+tag}return output.join("\n")};return{name:name,test:test,parse:parse}}return[HTML(),Base64Encoded(),Clash(),SSD()]}(),PROXY_PARSERS=function(){function URI_SS(){const name="URI SS Parser",test=line=>/^ss:\/\//.test(line),parse=line=>{const supported={};let content=line.split("ss://")[1];const proxy={name:decodeURIComponent(line.split("#")[1]),type:"ss",supported:supported};content=content.split("#")[0];const serverAndPort=content.match(/@([^\/]*)(\/|$)/)[1],portIdx=serverAndPort.lastIndexOf(":");proxy.server=serverAndPort.substring(0,portIdx),proxy.port=serverAndPort.substring(portIdx+1);const userInfo=Base64.safeDecode(content.split("@")[0]).split(":");proxy.cipher=userInfo[0],proxy.password=userInfo[1];const idx=content.indexOf("?plugin=");if(-1!==idx){const pluginInfo=("plugin="+decodeURIComponent(content.split("?plugin=")[1].split("&")[0])).split(";"),params={};for(const item of pluginInfo){const[key,val]=item.split("=");key&&(params[key]=val||!0)}switch(params.plugin){case"obfs-local":case"simple-obfs":proxy.plugin="obfs",proxy["plugin-opts"]={mode:params.obfs,host:params["obfs-host"]};break;case"v2ray-plugin":proxy.supported={...supported,Loon:!1,Surge:!1},proxy.obfs="v2ray-plugin",proxy["plugin-opts"]={mode:"websocket",host:params["obfs-host"],path:params.path||"",tls:params.tls||!1};break;default:throw new Error(`Unsupported plugin option: ${params.plugin}`)}}return proxy};return{name:name,test:test,parse:parse}}function URI_SSR(){const name="URI SSR Parser",test=line=>/^ssr:\/\//.test(line),supported={Surge:!1},parse=line=>{let splitIdx=(line=Base64.safeDecode(line.split("ssr://")[1])).indexOf(":origin");-1===splitIdx&&(splitIdx=line.indexOf(":auth_"));const serverAndPort=line.substring(0,splitIdx),server=serverAndPort.substring(0,serverAndPort.lastIndexOf(":")),port=serverAndPort.substring(serverAndPort.lastIndexOf(":")+1);let params=line.substring(splitIdx+1).split("/?")[0].split(":"),proxy={type:"ssr",server:server,port:port,protocol:params[0],cipher:params[1],obfs:params[2],password:Base64.safeDecode(params[3]),supported:supported};const other_params={};if((line=line.split("/?")[1].split("&")).length>1)for(const item of line){const[key,val]=item.split("=");other_params[key]=val.trim()}return proxy={...proxy,name:other_params.remarks?Base64.safeDecode(other_params.remarks):proxy.server,"protocol-param":Base64.safeDecode(other_params.protoparam||"").replace(/\s/g,""),"obfs-param":Base64.safeDecode(other_params.obfsparam||"").replace(/\s/g,"")},proxy};return{name:name,test:test,parse:parse}}function URI_VMess(){const name="URI VMess Parser",test=line=>/^vmess:\/\//.test(line),parse=line=>{const supported={};line=line.split("vmess://")[1];const content=Base64.safeDecode(line);if(/=\s*vmess/.test(content)){const partitions=content.split(",").map(p=>p.trim()),params={};for(const part of partitions)if(-1!==part.indexOf("=")){const[key,val]=part.split("=");params[key.trim()]=val.trim()}const proxy={name:partitions[0].split("=")[0].trim(),type:"vmess",server:partitions[1],port:partitions[2],cipher:partitions[3],uuid:partitions[4].match(/^"(.*)"$/)[1],tls:"over-tls"===params.obfs||"wss"===params.obfs};if(void 0!==params["udp-relay"]&&(proxy.udp=JSON.parse(params["udp-relay"])),void 0!==params["fast-open"]&&(proxy.udp=JSON.parse(params["fast-open"])),"ws"===params.obfs||"wss"===params.obfs){proxy.network="ws",proxy["ws-path"]=(params["obfs-path"]||'"/"').match(/^"(.*)"$/)[1];let obfs_host=params["obfs-header"];obfs_host&&-1!==obfs_host.indexOf("Host")&&(obfs_host=obfs_host.match(/Host:\s*([a-zA-Z0-9-.]*)/)[1]),proxy["ws-headers"]={Host:obfs_host||proxy.server}}return proxy.tls&&"false"===params['"tls-verification"']&&(proxy["skip-cert-verify"]=!0),proxy.tls&&params["obfs-host"]&&(proxy.sni=params["obfs-host"]),proxy}{const params=JSON.parse(content),proxy={name:params.ps,type:"vmess",server:params.add,port:params.port,cipher:"auto",uuid:params.id,alterId:params.aid||0,tls:"tls"===params.tls||!0===params.tls,supported:supported};return"ws"===params.net&&(proxy.network="ws",proxy["ws-path"]=params.path,proxy["ws-headers"]={Host:params.host||params.add},proxy.tls&&params.host&&(proxy.sni=params.host)),!1===params.verify_cert&&(proxy["skip-cert-verify"]=!0),proxy}};return{name:name,test:test,parse:parse}}function URI_Trojan(){const name="URI Trojan Parser",test=line=>/^trojan:\/\//.test(line),parse=line=>{const supported={};line=line.split("trojan://")[1];const[server,port]=line.split("@")[1].split("?")[0].split(":"),name=decodeURIComponent(line.split("#")[1].trim());return{name:name||`[Trojan] ${server}`,type:"trojan",server:server,port:port,password:line.split("@")[0],supported:supported}};return{name:name,test:test,parse:parse}}function Clash_All(){const name="Clash Parser",test=line=>{try{JSON.parse(line)}catch(e){return!1}return!0},parse=line=>JSON.parse(line);return{name:name,test:test,parse:parse}}function QX_SS(){const name="QX SS Parser",test=line=>/^shadowsocks\s*=/.test(line.split(",")[0].trim())&&-1===line.indexOf("ssr-protocol"),parse=line=>{const supported={},params=getQXParams(line),proxy={name:params.tag,type:"ss",server:params.server,port:params.port,cipher:params.method,password:params.password,udp:JSON.parse(params["udp-relay"]||"false"),tfo:JSON.parse(params["fast-open"]||"false"),supported:supported};if(params.obfs)switch(proxy["plugin-opts"]={host:params["obfs-host"]||proxy.server},params.obfs){case"http":case"tls":proxy.plugin="obfs",proxy["plugin-opts"].mode=params.obfs;break;case"ws":case"wss":proxy["plugin-opts"]={...proxy["plugin-opts"],mode:"websocket",path:params["obfs-uri"]||"/",tls:"wss"===params.obfs},proxy["plugin-opts"].tls&&void 0!==params["tls-verification"]&&(proxy["plugin-opts"]["skip-cert-verify"]=params["tls-verification"]),proxy.plugin="v2ray-plugin",proxy.supported.Surge=!1,proxy.supported.Loon=!1}return proxy};return{name:name,test:test,parse:parse}}function QX_SSR(){const name="QX SSR Parser",test=line=>/^shadowsocks\s*=/.test(line.split(",")[0].trim())&&-1!==line.indexOf("ssr-protocol"),parse=line=>{const supported={Surge:!1},params=getQXParams(line),proxy={name:params.tag,type:"ssr",server:params.server,port:params.port,cipher:params.method,password:params.password,protocol:params["ssr-protocol"],obfs:"plain","protocol-param":params["ssr-protocol-param"],udp:JSON.parse(params["udp-relay"]||"false"),tfo:JSON.parse(params["fast-open"]||"false"),supported:supported};return params.obfs&&(proxy.obfs=params.obfs,proxy["obfs-param"]=params["obfs-host"]),proxy};return{name:name,test:test,parse:parse}}function QX_VMess(){const name="QX VMess Parser",test=line=>/^vmess\s*=/.test(line.split(",")[0].trim()),parse=line=>{const params=getQXParams(line),proxy={type:"vmess",name:params.tag,server:params.server,port:params.port,cipher:params.method||"none",uuid:params.password,alterId:0,tls:"over-tls"===params.obfs||"wss"===params.obfs,udp:JSON.parse(params["udp-relay"]||"false"),tfo:JSON.parse(params["fast-open"]||"false")};return proxy.tls&&(proxy.sni=params["obfs-host"]||params.server,proxy["skip-cert-verify"]=!JSON.parse(params["tls-verification"]||"true")),"ws"!==params.obfs&&"wss"!==params.obfs||(proxy.network="ws",proxy["ws-path"]=params["obfs-uri"],proxy["ws-headers"]={Host:params["obfs-host"]||params.server}),proxy};return{name:name,test:test,parse:parse}}function QX_Trojan(){const name="QX Trojan Parser",test=line=>/^trojan\s*=/.test(line.split(",")[0].trim()),parse=line=>{const params=getQXParams(line),proxy={type:"trojan",name:params.tag,server:params.server,port:params.port,password:params.password,sni:params["tls-host"]||params.server,udp:JSON.parse(params["udp-relay"]||"false"),tfo:JSON.parse(params["fast-open"]||"false")};return proxy["skip-cert-verify"]=!JSON.parse(params["tls-verification"]||"true"),proxy};return{name:name,test:test,parse:parse}}function QX_Http(){const name="QX HTTP Parser",test=line=>/^http\s*=/.test(line.split(",")[0].trim()),parse=line=>{const params=getQXParams(line),proxy={type:"http",name:params.tag,server:params.server,port:params.port,tls:JSON.parse(params["over-tls"]||"false"),udp:JSON.parse(params["udp-relay"]||"false"),tfo:JSON.parse(params["fast-open"]||"false")};return params.username&&"none"!==params.username&&(proxy.username=params.username),params.password&&"none"!==params.password&&(proxy.password=params.password),proxy.tls&&(proxy.sni=params["tls-host"]||proxy.server,proxy["skip-cert-verify"]=!JSON.parse(params["tls-verification"]||"true")),proxy};return{name:name,test:test,parse:parse}}function getQXParams(line){const groups=line.split(","),params={},protocols=["shadowsocks","vmess","http","trojan"];return groups.forEach(g=>{let[key,value]=g.split("=");if(key=key.trim(),value=value.trim(),-1!==protocols.indexOf(key)){params.type=key;const conf=value.split(":");params.server=conf[0],params.port=conf[1]}else params[key.trim()]=value.trim()}),params}function Loon_SS(){const name="Loon SS Parser",test=line=>"shadowsocks"===line.split(",")[0].split("=")[1].trim().toLowerCase(),parse=line=>{const params=line.split("=")[1].split(","),proxy={name:line.split("=")[0].trim(),type:"ss",server:params[1],port:params[2],cipher:params[3],password:params[4].replace(/"/g,"")};return params.length>5&&(proxy.plugin="obfs",proxy["plugin-opts"]={mode:params[5],host:params[6]}),proxy};return{name:name,test:test,parse:parse}}function Loon_SSR(){const name="Loon SSR Parser",test=line=>"shadowsocksr"===line.split(",")[0].split("=")[1].trim().toLowerCase(),parse=line=>{const params=line.split("=")[1].split(","),supported={Surge:!1};return{name:line.split("=")[0].trim(),type:"ssr",server:params[1],port:params[2],cipher:params[3],password:params[4].replace(/"/g,""),protocol:params[5],"protocol-param":params[6].match(/{(.*)}/)[1],supported:supported,obfs:params[7],"obfs-param":params[8].match(/{(.*)}/)[1]}};return{name:name,test:test,parse:parse}}function Loon_VMess(){const name="Loon VMess Parser",test=line=>/^.*=\s*vmess/i.test(line.split(",")[0])&&-1===line.indexOf("username"),parse=line=>{let params=line.split("=")[1].split(",");const proxy={name:line.split("=")[0].trim(),type:"vmess",server:params[1],port:params[2],cipher:params[3]||"none",uuid:params[4].replace(/"/g,""),alterId:0};params=params.splice(5);for(const item of params){const[key,val]=item.split(":");params[key]=val}switch(proxy.tls=JSON.parse(params["over-tls"]||"false"),proxy.tls&&(proxy.sni=params["tls-name"]||proxy.server,proxy["skip-cert-verify"]=JSON.parse(params["skip-cert-verify"]||"false")),params.transport){case"tcp":break;case"ws":proxy.network=params.transport,proxy["ws-path"]=params.path,proxy["ws-headers"]={Host:params.host}}return proxy.tls&&(proxy["skip-cert-verify"]=JSON.parse(params["skip-cert-verify"]||"false")),proxy};return{name:name,test:test,parse:parse}}function Loon_Trojan(){const name="Loon Trojan Parser",test=line=>/^.*=\s*trojan/i.test(line.split(",")[0])&&-1===line.indexOf("password"),parse=line=>{const params=line.split("=")[1].split(","),proxy={name:line.split("=")[0].trim(),type:"trojan",server:params[1],port:params[2],password:params[3].replace(/"/g,""),sni:params[1],"skip-cert-verify":JSON.parse(params["skip-cert-verify"]||"false")};if(params.length>4){const[key,val]=params[4].split(":");if("tls-name"!==key)throw new Error(`Unknown option ${key} for line: \n${line}`);proxy.sni=val}return proxy};return{name:name,test:test,parse:parse}}function Loon_Http(){const name="Loon HTTP Parser",test=line=>/^.*=\s*http/i.test(line.split(",")[0])&&5===line.split(",").length&&-1===line.indexOf("username")&&-1===line.indexOf("password"),parse=line=>{const params=line.split("=")[1].split(","),proxy={name:line.split("=")[0].trim(),type:"http",server:params[1],port:params[2],tls:"443"===params[2]};return params[3]&&(proxy.username=params[3]),params[4]&&(proxy.password=params[4]),proxy.tls&&(proxy.sni=params["tls-name"]||proxy.server,proxy["skip-cert-verify"]=JSON.parse(params["skip-cert-verify"]||"false")),proxy};return{name:name,test:test,parse:parse}}function Surge_SS(){const name="Surge SS Parser",test=line=>/^.*=\s*ss/.test(line.split(",")[0]),parse=line=>{const params=getSurgeParams(line),proxy={name:params.name,type:"ss",server:params.server,port:params.port,cipher:params["encrypt-method"],password:params.password,tfo:JSON.parse(params.tfo||"false"),udp:JSON.parse(params["udp-relay"]||"false")};return params.obfs&&(proxy.plugin="obfs",proxy["plugin-opts"]={mode:params.obfs,host:params["obfs-host"]}),proxy};return{name:name,test:test,parse:parse}}function Surge_VMess(){const name="Surge VMess Parser",test=line=>/^.*=\s*vmess/.test(line.split(",")[0])&&-1!==line.indexOf("username"),parse=line=>{const params=getSurgeParams(line),proxy={name:params.name,type:"vmess",server:params.server,port:params.port,uuid:params.username,alterId:0,cipher:"none",tls:JSON.parse(params.tls||"false"),tfo:JSON.parse(params.tfo||"false")};if(proxy.tls&&(void 0!==params["skip-cert-verify"]&&(proxy["skip-cert-verify"]=!0===params["skip-cert-verify"]||"1"===params["skip-cert-verify"]),proxy.sni=params.sni||params.server),JSON.parse(params.ws||"false")){proxy.network="ws",proxy["ws-path"]=params["ws-path"];const res=params["ws-headers"].match(/(,|^|\s)*HOST:\s*(.*?)(,|$)/),host=res?res[2]:proxy.server;proxy["ws-headers"]={Host:host||params.server}}return proxy};return{name:name,test:test,parse:parse}}function Surge_Trojan(){const name="Surge Trojan Parser",test=line=>/^.*=\s*trojan/.test(line.split(",")[0])&&-1!==line.indexOf("sni"),parse=line=>{const params=getSurgeParams(line),proxy={name:params.name,type:"trojan",server:params.server,port:params.port,password:params.password,sni:params.sni||params.server,tfo:JSON.parse(params.tfo||"false")};return void 0!==params["skip-cert-verify"]&&(proxy["skip-cert-verify"]=!0===params["skip-cert-verify"]||"1"===params["skip-cert-verify"]),proxy};return{name:name,test:test,parse:parse}}function Surge_Http(){const name="Surge HTTP Parser",test=line=>/^.*=\s*http/.test(line.split(",")[0])&&!Loon_Http().test(line),parse=line=>{const params=getSurgeParams(line),proxy={name:params.name,type:"http",server:params.server,port:params.port,tls:JSON.parse(params.tls||"false"),tfo:JSON.parse(params.tfo||"false")};return proxy.tls&&(void 0!==params["skip-cert-verify"]&&(proxy["skip-cert-verify"]=!0===params["skip-cert-verify"]||"1"===params["skip-cert-verify"]),proxy.sni=params.sni||params.server),params.username&&"none"!==params.username&&(proxy.username=params.username),params.password&&"none"!==params.password&&(proxy.password=params.password),proxy};return{name:name,test:test,parse:parse}}function getSurgeParams(line){const params={};params.name=line.split("=")[0].trim();const segments=line.split(",");params.server=segments[1].trim(),params.port=segments[2].trim();for(let i=3;i<segments.length;i++){const item=segments[i];if(-1!==item.indexOf("=")){const[key,value]=item.split("=");params[key.trim()]=value.trim()}}return params}return[URI_SS(),URI_SSR(),URI_VMess(),URI_Trojan(),Clash_All(),Surge_SS(),Surge_VMess(),Surge_Trojan(),Surge_Http(),Loon_SS(),Loon_SSR(),Loon_VMess(),Loon_Trojan(),Loon_Http(),QX_SS(),QX_SSR(),QX_VMess(),QX_Trojan(),QX_Http()]}(),PROXY_PROCESSORS=function(){function SetPropertyOperator({key:key,value:value}){return{name:"Set Property Operator",func:proxies=>proxies.map(p=>(p[key]=value,p))}}function FlagOperator(add=!0){return{name:"Flag Operator",func:proxies=>proxies.map(proxy=>{if(add){const newFlag=getFlag(proxy.name);proxy.name=removeFlag(proxy.name),proxy.name=newFlag+" "+proxy.name,proxy.name=proxy.name.replace(/ğŸ‡¹ğŸ‡¼/g,"ğŸ‡¨ğŸ‡³")}else proxy.name=removeFlag(proxy.name);return proxy})}}function HandleDuplicateOperator(arg){const{action:action,template:template,link:link,position:position}={action:"rename",template:"0 1 2 3 4 5 6 7 8 9",link:"-",position:"back",...arg};return{name:"Handle Duplicate Operator",func:proxies=>{if("delete"===action){const chosen={};return proxies.filter(p=>!chosen[p.name]&&(chosen[p.name]=!0,!0))}if("rename"===action){const numbers=template.split(" "),counter={};let maxLen=0;proxies.forEach(p=>{void 0===counter[p.name]?counter[p.name]=1:counter[p.name]++,maxLen=Math.max(counter[p.name].toString().length,maxLen)});const increment={};return proxies.map(p=>{if(counter[p.name]>1){void 0===increment[p.name]&&(increment[p.name]=1);let num="",cnt=increment[p.name]++,numDigits=0;for(;cnt>0;)num=numbers[cnt%10]+num,cnt=parseInt(cnt/10),numDigits++;for(;numDigits++<maxLen;)num=numbers[0]+num;"front"===position?p.name=num+link+p.name:"back"===position&&(p.name=p.name+link+num)}return p})}}}}function SortOperator(order="asc"){return{name:"Sort Operator",func:proxies=>{switch(order){case"asc":case"desc":return proxies.sort((a,b)=>{let res=a.name>b.name?1:-1;return res*="desc"===order?-1:1,res});case"random":return shuffle(proxies);default:throw new Error("Unknown sort option: "+order)}}}}function RegexSortOperator(expressions){return{name:"Regex Sort Operator",func:proxies=>(expressions=expressions.map(expr=>buildRegex(expr)),proxies.sort((a,b)=>{const oA=getRegexOrder(expressions,a.name),oB=getRegexOrder(expressions,b.name);return oA&&!oB?-1:oB&&!oA?1:oA&&oB?oA<oB?-1:1:!oA&&!oB||oA&&oB&&oA===oB?a.name<b.name?-1:1:void 0}))}}function getRegexOrder(expressions,str){let order=null;for(let i=0;i<expressions.length;i++)if(expressions[i].test(str)){order=i+1;break}return order}function RegexRenameOperator(regex){return{name:"Regex Rename Operator",func:proxies=>proxies.map(proxy=>{for(const{expr:expr,now:now}of regex)proxy.name=proxy.name.replace(buildRegex(expr,"g"),now).trim();return proxy})}}function RegexDeleteOperator(regex){const regex_=regex.map(r=>({expr:r,now:""}));return{name:"Regex Delete Operator",func:RegexRenameOperator(regex_).func}}function ScriptOperator(script){return{name:"Script Operator",func:proxies=>{let output=proxies;return function(){const $get=(name,args)=>{const item=PROXY_PROCESSORS[name];return item(args)},$process=ApplyProcessor;eval(script),output=operator(proxies)}(),output}}}function UselessFilter(){const KEYWORDS=["ç½‘å€","æµé‡","æ—¶é—´","åº”æ€¥","è¿‡æœŸ","Bandwidth","expire"];return{name:"Useless Filter",func:RegexFilter({regex:KEYWORDS,keep:!1}).func}}function RegionFilter(regions){const REGION_MAP={HK:"ğŸ‡­ğŸ‡°",TW:"ğŸ‡¹ğŸ‡¼",US:"ğŸ‡ºğŸ‡¸",SG:"ğŸ‡¸ğŸ‡¬",JP:"ğŸ‡¯ğŸ‡µ",UK:"ğŸ‡¬ğŸ‡§"};return{name:"Region Filter",func:proxies=>proxies.map(proxy=>{const flag=getFlag(proxy.name);return regions.some(r=>REGION_MAP[r]===flag)})}}function RegexFilter({regex:regex=[],keep:keep=!0}){return{name:"Regex Filter",func:proxies=>proxies.map(proxy=>{const selected=regex.some(r=>buildRegex(r).test(proxy.name));return keep?selected:!selected})}}function TypeFilter(types){return{name:"Type Filter",func:proxies=>proxies.map(proxy=>types.some(t=>proxy.type===t))}}function ScriptFilter(script){return{name:"Script Filter",func:proxies=>{let output=FULL(proxies.length,!0);return function(){eval(script),output=filter(proxies)}(),output}}}function getFlag(name){const flags={"ğŸ‡¦ğŸ‡¿":["é˜¿å¡æ‹œç–†"],"ğŸ‡¦ğŸ‡¹":["å¥¥åœ°åˆ©","å¥§åœ°åˆ©","Austria","ç»´ä¹Ÿçº³"],"ğŸ‡¦ğŸ‡º":["AU","Australia","Sydney","æ¾³å¤§åˆ©äºš","æ¾³æ´²","å¢¨å°”æœ¬","æ‚‰å°¼","åœŸæ¾³","äº¬æ¾³","å»£æ¾³","æ»¬æ¾³","æ²ªæ¾³","å¹¿æ¾³"],"ğŸ‡§ğŸ‡ª":["BE","æ¯”åˆ©æ™‚","æ¯”åˆ©æ—¶"],"ğŸ‡§ğŸ‡¬":["ä¿åŠ åˆ©äºš","ä¿åŠ åˆ©äº","Bulgaria"],"ğŸ‡µğŸ‡°":["å·´åŸºæ–¯å¦"],"ğŸ‡°ğŸ‡­":["æŸ¬åŸ”å¯¨"],"ğŸ‡ºğŸ‡¦":["çƒå…‹è˜­","ä¹Œå…‹å…°"],"ğŸ‡­ğŸ‡·":["å…‹ç½—åœ°äºš","HR","å…‹ç¾…åœ°äº"],"ğŸ‡¨ğŸ‡¦":["Canada","CANADA","CAN","Waterloo","åŠ æ‹¿å¤§","è’™ç‰¹åˆ©å°”","æ¸©å“¥å","æ¥“è‘‰","æ«å¶","æ»‘é“å¢","å¤šä¼¦å¤š"],"ğŸ‡¨ğŸ‡­":["ç‘å£«","è‹é»ä¸–","Switzerland"],"ğŸ‡³ğŸ‡¬":["å°¼æ—¥åˆ©äºš","NG","å°¼æ—¥åˆ©äº"],"ğŸ‡¨ğŸ‡¿":["Czechia","æ·å…‹"],"ğŸ‡¸ğŸ‡°":["æ–¯æ´›ä¼å…‹","SK"],"ğŸ‡·ğŸ‡¸":["RS","å¡å°”ç»´äºš"],"ğŸ‡²ğŸ‡©":["æ‘©çˆ¾å¤šç“¦","MD","æ‘©å°”å¤šç“¦"],"ğŸ‡©ğŸ‡ª":["DE","German","GERMAN","å¾·å›½","å¾·åœ‹","æ³•å…°å…‹ç¦","äº¬å¾·","æ»¬å¾·","å»£å¾·","æ²ªå¾·","å¹¿å¾·"],"ğŸ‡©ğŸ‡°":["DK","DNK","ä¸¹éº¦","ä¸¹éº¥"],"ğŸ‡ªğŸ‡¸":["ES","è¥¿ç­ç‰™","Spain"],"ğŸ‡ªğŸ‡º":["EU","æ¬§ç›Ÿ","æ¬§ç½—å·´"],"ğŸ‡«ğŸ‡®":["Finland","èŠ¬å…°","èŠ¬è˜­","èµ«å°”è¾›åŸº"],"ğŸ‡«ğŸ‡·":["FR","France","æ³•å›½","æ³•åœ‹","å·´é»"],"ğŸ‡¬ğŸ‡§":["UK","GB","England","United Kingdom","è‹±å›½","ä¼¦æ•¦","è‹±"],"ğŸ‡²ğŸ‡´":["MO","Macao","æ¾³é—¨","æ¾³é–€","CTM"],"ğŸ‡°ğŸ‡¿":["å“ˆè¨å…‹æ–¯å¦"],"ğŸ‡­ğŸ‡º":["åŒˆç‰™åˆ©","Hungary"],"ğŸ‡­ğŸ‡°":["HK","Hongkong","Hong Kong","HongKong","HONG KONG","é¦™æ¸¯","æ·±æ¸¯","æ²ªæ¸¯","å‘¼æ¸¯","HKT","HKBN","HGC","WTT","CMI","ç©—æ¸¯","äº¬æ¸¯","æ¸¯"],"ğŸ‡®ğŸ‡©":["Indonesia","å°å°¼","å°åº¦å°¼è¥¿äºš","é›…åŠ è¾¾"],"ğŸ‡®ğŸ‡ª":["Ireland","IRELAND","çˆ±å°”å…°","æ„›çˆ¾è˜­","éƒ½æŸæ—"],"ğŸ‡®ğŸ‡±":["Israel","ä»¥è‰²åˆ—"],"ğŸ‡®ğŸ‡³":["India","IND","INDIA","å°åº¦","å­Ÿä¹°","Mumbai"],"ğŸ‡®ğŸ‡¸":["IS","ISL","å†°å²›","å†°å³¶"],"ğŸ‡°ğŸ‡µ":["KP","æœé²œ"],"ğŸ‡°ğŸ‡·":["KR","Korea","KOR","éŸ©å›½","é¦–å°”","éŸ©","éŸ“","æ˜¥å·"],"ğŸ‡±ğŸ‡º":["å¢æ£®å ¡"],"ğŸ‡±ğŸ‡»":["Latvia","Latvija","æ‹‰è„±ç»´äºš"],"ğŸ‡²ğŸ‡½ï¸":["MEX","MX","å¢¨è¥¿å“¥"],"ğŸ‡²ğŸ‡¾":["MY","Malaysia","MALAYSIA","é©¬æ¥è¥¿äºš","å¤§é¦¬","é¦¬ä¾†è¥¿äº","å‰éš†å¡"],"ğŸ‡³ğŸ‡±":["NL","Netherlands","è·å…°","è·è˜­","å°¼å¾·è˜­","é˜¿å§†æ–¯ç‰¹ä¸¹"],"ğŸ‡µğŸ‡­":["PH","Philippines","è²å¾‹å®¾","è²å¾‹è³“"],"ğŸ‡·ğŸ‡´":["RO","ç½—é©¬å°¼äºš"],"ğŸ‡·ğŸ‡º":["RU","Russia","ä¿„ç½—æ–¯","ä¿„å›½","ä¿„ç¾…æ–¯","ä¼¯åŠ›","è«æ–¯ç§‘","åœ£å½¼å¾—å ¡","è¥¿ä¼¯åˆ©äºš","æ–°è¥¿ä¼¯åˆ©äºš","äº¬ä¿„","æ­ä¿„","å»£ä¿„","æ»¬ä¿„","å¹¿ä¿„","æ²ªä¿„"],"ğŸ‡¸ğŸ‡¦":["æ²™ç‰¹","è¿ªæ‹œ"],"ğŸ‡¸ğŸ‡ª":["SE","Sweden"],"ğŸ‡¸ğŸ‡¬":["SG","Singapore","SINGAPORE","æ–°åŠ å¡","ç‹®åŸ","æ²ªæ–°","äº¬æ–°","æ³‰æ–°","ç©—æ–°","æ·±æ–°","æ­æ–°","å¹¿æ–°","å»£æ–°","æ»¬æ–°"],"ğŸ‡¹ğŸ‡­":["TH","Thailand","æ³°å›½","æ³°åœ‹","æ›¼è°·"],"ğŸ‡¹ğŸ‡·":["TR","Turkey","åœŸè€³å…¶","ä¼Šæ–¯å¦å¸ƒå°”"],"ğŸ‡¹ğŸ‡¼":["TW","Taiwan","TAIWAN","å°æ¹¾","å°åŒ—","å°ä¸­","æ–°åŒ—","å½°åŒ–","CHT","å°","HINET"],"ğŸ‡ºğŸ‡¸":["US","USA","America","United States","ç¾å›½","ç¾","äº¬ç¾","æ³¢ç‰¹å…°","è¾¾æ‹‰æ–¯","ä¿„å‹’å†ˆ","å‡¤å‡°åŸ","è´¹åˆ©è’™","ç¡…è°·","çŸ½è°·","æ‹‰æ–¯ç»´åŠ æ–¯","æ´›æ‰çŸ¶","åœ£ä½•å¡","åœ£å…‹æ‹‰æ‹‰","è¥¿é›…å›¾","èŠåŠ å“¥","æ²ªç¾","å“¥ä¼¦å¸ƒ","çº½çº¦"],"ğŸ‡»ğŸ‡³":["VN","è¶Šå—","èƒ¡å¿—æ˜å¸‚"],"ğŸ‡®ğŸ‡¹":["Italy","IT","Nachash","æ„å¤§åˆ©","ç±³å…°","ç¾©å¤§åˆ©"],"ğŸ‡¿ğŸ‡¦":["South Africa","å—é"],"ğŸ‡¦ğŸ‡ª":["United Arab Emirates","é˜¿è”é…‹"],"ğŸ‡§ğŸ‡·":["BR","Brazil","å·´è¥¿","åœ£ä¿ç½—"],"ğŸ‡¯ğŸ‡µ":["JP","Japan","JAPAN","æ—¥æœ¬","ä¸œäº¬","å¤§é˜ª","åŸ¼ç‰","æ²ªæ—¥","ç©—æ—¥","å·æ—¥","ä¸­æ—¥","æ³‰æ—¥","æ­æ—¥","æ·±æ—¥","è¾½æ—¥","å¹¿æ—¥"],"ğŸ‡¦ğŸ‡·":["AR","é˜¿æ ¹å»·"],"ğŸ‡³ğŸ‡´":["Norway","æŒªå¨","NO"],"ğŸ‡¨ğŸ‡³":["CN","China","å›å›½","ä¸­å›½","ä¸­åœ‹","æ±Ÿè‹","åŒ—äº¬","ä¸Šæµ·","å¹¿å·","æ·±åœ³","æ­å·","å¾å·","é’å²›","å®æ³¢","é•‡æ±Ÿ","back"],"ğŸ‡µğŸ‡±":["PL","POL","æ³¢å…°","æ³¢è˜­"],"ğŸ‡¨ğŸ‡±":["æ™ºåˆ©"],"ğŸ‡³ğŸ‡¿":["æ–°è¥¿è˜­","æ–°è¥¿å…°"],"ğŸ‡¬ğŸ‡·":["å¸Œè…Š","å¸Œè‡˜"],"ğŸ‡ªğŸ‡¬":["åŸƒåŠ"],"ğŸ‡®ğŸ‡²":["é©¬æ©å²›","é¦¬æ©å³¶"],"ğŸ‡§ğŸ‡¾":["BY","ç™½ä¿„ç½—æ–¯"],"ğŸ‡µğŸ‡¹":["è‘¡è„ç‰™"],"ğŸ‡²ğŸ‡³":["è’™å¤"],"ğŸ‡µğŸ‡ª":["ç§˜é²","ç¥•é­¯"],"ğŸ‡¨ğŸ‡´":["å“¥ä¼¦æ¯”äºš"],"ğŸ‡ªğŸ‡ª":["çˆ±æ²™å°¼äºš"],"ğŸ‡²ğŸ‡°":["é©¬å…¶é¡¿","é¦¬å…¶é “"],"ğŸ‡§ğŸ‡¦":["æ³¢é»‘å…±å’Œå›½","æ³¢é»‘"],"ğŸ‡¬ğŸ‡ª":["æ ¼é­¯å‰äº","æ ¼é²å‰äºš"],"ğŸ‡¦ğŸ‡±":["é˜¿çˆ¾å·´å°¼äº","é˜¿å°”å·´å°¼äºš"],"ğŸ³ï¸â€ğŸŒˆ":["æµé‡","æ—¶é—´","åº”æ€¥","è¿‡æœŸ","Bandwidth","expire"]};for(let k of Object.keys(flags))if(flags[k].some(item=>-1!==name.indexOf(item)))return k;const oldFlag=(name.match(/[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/)||[])[0];return oldFlag||"ğŸ´â€â˜ ï¸"}function removeFlag(str){return str.replace(/[\uD83C][\uDDE6-\uDDFF][\uD83C][\uDDE6-\uDDFF]/g,"").trim()}function shuffle(array){let currentIndex=array.length,temporaryValue,randomIndex;for(;0!==currentIndex;)randomIndex=Math.floor(Math.random()*currentIndex),currentIndex-=1,temporaryValue=array[currentIndex],array[currentIndex]=array[randomIndex],array[randomIndex]=temporaryValue;return array}return{"Useless Filter":UselessFilter,"Region Filter":RegionFilter,"Regex Filter":RegexFilter,"Type Filter":TypeFilter,"Script Filter":ScriptFilter,"Set Property Operator":SetPropertyOperator,"Flag Operator":FlagOperator,"Sort Operator":SortOperator,"Regex Sort Operator":RegexSortOperator,"Regex Rename Operator":RegexRenameOperator,"Regex Delete Operator":RegexDeleteOperator,"Script Operator":ScriptOperator,"Handle Duplicate Operator":HandleDuplicateOperator}}(),PROXY_PRODUCERS=function(){function QX_Producer(){const targetPlatform="QX",produce=proxy=>{let obfs_opts,tls_opts;switch(proxy.type){case"ss":if(obfs_opts="","obfs"===proxy.plugin){const{host:host,mode:mode}=proxy["plugin-opts"];obfs_opts=`,obfs=${mode}${host?",obfs-host="+host:""}`}if("v2ray-plugin"===proxy.plugin){const{tls:tls,host:host,path:path}=proxy["plugin-opts"];obfs_opts=`,obfs=${tls?"wss":"ws"}${host?",obfs-host="+host:""}${path?",obfs-uri="+path:""}`}return`shadowsocks=${proxy.server}:${proxy.port},method=${proxy.cipher},password=${proxy.password}${obfs_opts}${proxy.tfo?",fast-open=true":",fast-open=false"}${proxy.udp?",udp-relay=true":",udp-relay=false"},tag=${proxy.name}`;case"ssr":return`shadowsocks=${proxy.server}:${proxy.port},method=${proxy.cipher},password=${proxy.password},ssr-protocol=${proxy.protocol}${proxy["protocol-param"]?",ssr-protocol-param="+proxy["protocol-param"]:""}${proxy.obfs?",obfs="+proxy.obfs:""}${proxy["obfs-param"]?",obfs-host="+proxy["obfs-param"]:""}${proxy.tfo?",fast-open=true":",fast-open=false"}${proxy.udp?",udp-relay=true":",udp-relay=false"},tag=${proxy.name}`;case"vmess":return obfs_opts="","ws"===proxy.network?obfs_opts=proxy.tls?`,obfs=wss${proxy.sni?",obfs-host="+proxy.sni:""}${proxy["ws-path"]?",obfs-uri="+proxy["ws-path"]:""},tls-verification=${proxy["skip-cert-verify"]?"false":"true"}`:`,obfs=ws${proxy["ws-headers"].Host?",obfs-host="+proxy["ws-headers"].Host:""}${proxy["ws-path"]?",obfs-uri="+proxy["ws-path"]:""}`:proxy.tls&&(obfs_opts=`,obfs=over-tls${proxy.sni?",obfs-host="+proxy.sni:""},tls-verification=${proxy["skip-cert-verify"]?"false":"true"}`),`vmess=${proxy.server}:${proxy.port},method=${"auto"===proxy.cipher?"none":proxy.cipher},password=${proxy.uuid}${obfs_opts}${proxy.tfo?",fast-open=true":",fast-open=false"}${proxy.udp?",udp-relay=true":",udp-relay=false"},tag=${proxy.name}`;case"trojan":return`trojan=${proxy.server}:${proxy.port},password=${proxy.password}${proxy.sni?",tls-host="+proxy.sni:""},over-tls=true,tls-verification=${proxy["skip-cert-verify"]?"false":"true"}${proxy.tfo?",fast-open=true":",fast-open=false"}${proxy.udp?",udp-relay=true":",udp-relay=false"},tag=${proxy.name}`;case"http":return tls_opts="",proxy.tls&&(tls_opts=`,over-tls=true,tls-verification=${proxy["skip-cert-verify"]?"false":"true"}${proxy.sni?",tls-host="+proxy.sni:""}`),`http=${proxy.server}:${proxy.port},username=${proxy.username},password=${proxy.password}${tls_opts}${proxy.tfo?",fast-open=true":",fast-open=false"},tag=${proxy.name}`}throw new Error(`Platform QX does not support proxy type: ${proxy.type}`)};return{produce:produce}}function Loon_Producer(){const targetPlatform="Loon",produce=proxy=>{let obfs_opts,tls_opts,udp_opts,tfo_opts;switch(void 0!==proxy.udp&&(udp_opts=proxy.udp?",udp=true":",udp=false"),void 0!==proxy.tfo&&(tfo_opts=proxy.tfo?",fast-open=true":",fast-open=false"),proxy.type){case"ss":if(obfs_opts=",,",proxy.plugin){if("obfs"!==proxy.plugin)throw new Error(`Platform Loon does not support obfs option: ${proxy.obfs}`);{const{mode:mode,host:host}=proxy["plugin-opts"];obfs_opts=`,${mode},${host||""}`}}return`${proxy.name}=shadowsocks,${proxy.server},${proxy.port},${proxy.cipher},"${proxy.password}"${obfs_opts}${udp_opts}${tfo_opts}`;case"ssr":return`${proxy.name}=shadowsocksr,${proxy.server},${proxy.port},${proxy.cipher},"${proxy.password}",${proxy.protocol},{${proxy["protocol-param"]||""}},${proxy.obfs},{${proxy["obfs-param"]||""}}${udp_opts}${tfo_opts}`;case"vmess":if(obfs_opts="","ws"===proxy.network){const host=proxy["ws-headers"].Host||proxy.server;obfs_opts=`,transport:ws,host:${host},path:${proxy["ws-path"]||"/"}`}else obfs_opts=",transport:tcp";return proxy.tls&&(obfs_opts+=`${proxy.sni?",tls-name:"+proxy.sni:""},skip-cert-verify:${proxy["skip-cert-verify"]||"false"}`),`${proxy.name}=vmess,${proxy.server},${proxy.port},${"auto"===proxy.cipher?"none":proxy.cipher},"${proxy.uuid}",over-tls:${proxy.tls||"false"}${obfs_opts}`;case"trojan":return`${proxy.name}=trojan,${proxy.server},${proxy.port},"${proxy.password}"${proxy.sni?",tls-name:"+proxy.sni:""},skip-cert-verify:${proxy["skip-cert-verify"]||"false"}`;case"http":tls_opts="";const base=`${proxy.name}=${proxy.tls?"http":"https"},${proxy.server},${proxy.port},${proxy.username||""},${proxy.password||""}`;return proxy.tls?(tls_opts=`${proxy.sni?",tls-name:"+proxy.sni:""},skip-cert-verify:${proxy["skip-cert-verify"]}`,base+tls_opts):base}throw new Error(`Platform Loon does not support proxy type: ${proxy.type}`)};return{produce:produce}}function Surge_Producer(){const targetPlatform="Surge",produce=proxy=>{let result="",obfs_opts,tls_opts;switch(proxy.type){case"ss":if(obfs_opts="",proxy.plugin){const{host:host,mode:mode}=proxy["plugin-opts"];if("obfs"!==proxy.plugin)throw new Error(`Platform Surge does not support obfs option: ${proxy.obfs}`);obfs_opts=`,obfs=${mode}${host?",obfs-host="+host:""}`}result=`${proxy.name}=ss,${proxy.server}, ${proxy.port},encrypt-method=${proxy.cipher},password=${proxy.password}${obfs_opts},tfo=${proxy.tfo||"false"},udp-relay=${proxy.udp||"false"}`;break;case"vmess":if(tls_opts="",result=`${proxy.name}=vmess,${proxy.server},${proxy.port},username=${proxy.uuid},tls=${proxy.tls||"false"},tfo=${proxy.tfo||"false"}`,"ws"===proxy.network){const path=proxy["ws-path"]||"/",wsHeaders=Object.entries(proxy["ws-headers"]).map(([key,value])=>`${key}:"${value}"`).join("|");result+=`,ws=true${path?",ws-path="+path:""}${wsHeaders?",ws-headers="+wsHeaders:""}`}proxy.tls&&(result+=`${void 0!==proxy["skip-cert-verify"]?",skip-cert-verify="+proxy["skip-cert-verify"]:""}`,result+=proxy.sni?`,sni=${proxy.sni}`:"");break;case"trojan":result=`${proxy.name}=trojan,${proxy.server},${proxy.port},password=${proxy.password}${void 0!==proxy["skip-cert-verify"]?",skip-cert-verify="+proxy["skip-cert-verify"]:""}${proxy.sni?",sni="+proxy.sni:""},tfo=${proxy.tfo||"false"}`;break;case"http":tls_opts=", tls=false",proxy.tls&&(tls_opts=`,tls=true,skip-cert-verify=${proxy["skip-cert-verify"]},sni=${proxy.sni}`),result=`${proxy.name}=http, ${proxy.server}, ${proxy.port}${proxy.username?",username="+proxy.username:""}${proxy.password?",password="+proxy.password:""}${tls_opts},tfo=${proxy.tfo||"false"}`;break;default:throw new Error(`Platform Surge does not support proxy type: ${proxy.type}`)}return result+=void 0!==proxy["surge-hybrid"]?`,hybrid=${proxy["surge-hybrid"]}`:"",result};return{produce:produce}}function Clash_Producer(){const type="ALL",produce=proxies=>"proxies:\n"+proxies.map(proxy=>(delete proxy.supported,"  - "+JSON.stringify(proxy)+"\n")).join("");return{type:type,produce:produce}}function URI_Producer(){const type="SINGLE",produce=proxy=>{let result="";switch(proxy.type){case"ss":const userinfo=`${proxy.cipher}:${proxy.password}`;if(result=`ss://${Base64.safeEncode(userinfo)}@${proxy.server}:${proxy.port}/`,proxy.plugin){result+="?plugin=";const opts=proxy["plugin-opts"];switch(proxy.plugin){case"obfs":result+=encodeURIComponent(`simple-obfs;obfs=${opts.mode}${opts.host?";obfs-host="+opts.host:""}`);break;case"v2ray-plugin":result+=encodeURIComponent(`v2ray-plugin;obfs=${opts.mode}${opts.host?";obfs-host"+opts.host:""}${opts.tls?";tls":""}`);break;default:throw new Error(`Unsupported plugin option: ${proxy.plugin}`)}}result+=`#${encodeURIComponent(proxy.name)}`;break;case"ssr":result=`${proxy.server}:${proxy.port}:${proxy.protocol}:${proxy.cipher}:${proxy.obfs}:${Base64.safeEncode(proxy.password)}/`,result+=`?remarks=${Base64.safeEncode(proxy.name)}${proxy["obfs-param"]?"&obfsparam="+Base64.safeEncode(proxy["obfs-param"]):""}${proxy["protocol-param"]?"&protocolparam="+Base64.safeEncode(proxy["protocol-param"]):""}`,result="ssr://"+Base64.safeEncode(result);break;case"vmess":result={ps:proxy.name,add:proxy.server,port:proxy.port,id:proxy.uuid,type:"",aid:0,net:proxy.network||"tcp",tls:proxy.tls?"tls":""},"ws"===proxy.network&&(result.path=proxy["ws-path"]||"/",result.host=proxy["ws-headers"].Host||proxy.server),result="vmess://"+Base64.safeEncode(JSON.stringify(result));break;case"trojan":result=`trojan://${proxy.password}@${proxy.server}:${proxy.port}#${encodeURIComponent(proxy.name)}`;break;default:throw new Error(`Cannot handle proxy type: ${proxy.type}`)}return result};return{type:type,produce:produce}}function JSON_Producer(){const type="ALL",produce=proxies=>JSON.stringify(proxies,null,2);return{type:type,produce:produce}}return{QX:QX_Producer(),Surge:Surge_Producer(),Loon:Loon_Producer(),Clash:Clash_Producer(),URI:URI_Producer(),JSON:JSON_Producer()}}();function preprocess(raw){for(const processor of PROXY_PREPROCESSORS)try{if(processor.test(raw))return $.info(`Pre-processor [${processor.name}] activated`),processor.parse(raw)}catch(e){$.error(`Parser [${processor.name}] failed\n Reason: ${e}`)}return raw}function safeMatch(p,line){let patternMatched;try{patternMatched=p.test(line)}catch(err){patternMatched=!1}return patternMatched}function parse(raw){const lines=(raw=preprocess(raw)).split("\n"),proxies=[];let lastParser;for(let line of lines){if(line=line.replace(/\s+?/g,""),0===line.length)continue;let matched=lastParser&&safeMatch(lastParser,line);if(!matched)for(const parser of PROXY_PARSERS)if(safeMatch(parser,line)){lastParser=parser,matched=!0,$.info(`Proxy parser: ${parser.name} is activated`);break}if(matched)try{const proxy=lastParser.parse(line);proxy||$.error(`Parser ${lastParser.name} return nothing for \n${line}\n`),proxies.push(proxy)}catch(err){$.error(`Failed to parse line: \n ${line}\n Reason: ${err.stack}`)}else $.error(`Failed to find a rule to parse line: \n${line}\n`)}return proxies}async function process(proxies,operators=[]){for(const item of operators){let script,processor;if(-1!==item.type.indexOf("Script")){const{mode:mode,content:content}=item.args;if("link"===mode)try{script=await $.http.get(content).then(resp=>resp.body)}catch(err){$.error(`Error when downloading remote script: ${item.args.content}.\n Reason: ${err}`);continue}else script=content}PROXY_PROCESSORS[item.type]?($.info(`Applying "${item.type}" with arguments:\n >>> ${JSON.stringify(item.args,null,2)||"None"}`),processor=-1!==item.type.indexOf("Script")?PROXY_PROCESSORS[item.type](script):PROXY_PROCESSORS[item.type](item.args),proxies=ApplyProcessor(processor,proxies)):$.error(`Unknown operator: "${item.type}"`)}return proxies}function produce(proxies,targetPlatform){const producer=PROXY_PRODUCERS[targetPlatform];if(!producer)throw new Error(`Target platform: ${targetPlatform} is not supported!`);return proxies=proxies.filter(proxy=>!(proxy.supported&&!1===proxy.supported[targetPlatform])),$.info(`Producing proxies for target: ${targetPlatform}`),void 0===producer.type||"SINGLE"===producer.type?proxies.map(proxy=>{try{return producer.produce(proxy)}catch(err){return $.error(`Cannot produce proxy: ${JSON.stringify(proxy,null,2)}\nReason: ${err}`),""}}).filter(line=>line.length>0).join("\n"):"ALL"===producer.type?producer.produce(proxies):void 0}return{parse:parse,process:process,produce:produce}}(),RuleUtils=function(){const RULE_TYPES_MAPPING=[[/^(DOMAIN|host|HOST)$/,"DOMAIN"],[/^(DOMAIN-KEYWORD|host-keyword|HOST-KEYWORD)$/,"DOMAIN-KEYWORD"],[/^(DOMAIN-SUFFIX|host-suffix|HOST-SUFFIX)$/,"DOMAIN-SUFFIX"],[/^USER-AGENT$/i,"USER-AGENT"],[/^PROCESS-NAME$/,"PROCESS-NAME"],[/^(DEST-PORT|DST-PORT)$/,"DST-PORT"],[/^SRC-IP(-CIDR)?$/,"SRC-IP"],[/^(IN|SRC)-PORT$/,"IN-PORT"],[/^PROTOCOL$/,"PROTOCOL"],[/^IP-CIDR$/i,"IP-CIDR"],[/^(IP-CIDR6|ip6-cidr|IP6-CIDR)$/]],RULE_PREPROCESSORS=function(){function HTML(){const name="HTML",test=raw=>/^<!DOCTYPE html>/.test(raw),parse=_=>"";return{name:name,test:test,parse:parse}}function ClashProvider(){const name="Clash Provider",test=raw=>0===raw.indexOf("payload:"),parse=raw=>raw.replace("payload:","").replace(/^\s*-\s*/gm,"");return{name:name,test:test,parse:parse}}return[HTML(),ClashProvider()]}(),RULE_PARSERS=function(){function AllRuleParser(){const name="Universal Rule Parser",test=()=>!0,parse=raw=>{const lines=raw.split("\n"),result=[];for(let line of lines)if(line=line.trim(),0!==line.length&&!/\s*#/.test(line))try{const params=line.split(",").map(w=>w.trim());let rawType=params[0],matched=!1;for(const item of RULE_TYPES_MAPPING){const regex=item[0];if(regex.test(rawType)){matched=!0;const rule={type:item[1],content:params[1]};"IP-CIDR"!==rule.type&&"IP-CIDR6"!==rule.type||(rule.options=params.slice(2)),result.push(rule)}}if(!matched)throw new Error("Invalid rule type: "+rawType)}catch(e){console.error(`Failed to parse line: ${line}\n Reason: ${e}`)}return result};return{name:name,test:test,parse:parse}}return[AllRuleParser()]}(),RULE_PROCESSORS=function(){function RegexFilter({regex:regex=[],keep:keep=!0}){return{name:"Regex Filter",func:rules=>rules.map(rule=>{const selected=regex.some(r=>(r=new RegExp(r)).test(rule));return keep?selected:!selected})}}function TypeFilter(types){return{name:"Type Filter",func:rules=>rules.map(rule=>types.some(t=>rule.type===t))}}function RemoveDuplicateFilter(){return{name:"Remove Duplicate Filter",func:rules=>{const seen=new Set,result=[];return rules.forEach(rule=>{const options=rule.options||[];options.sort();const key=`${rule.type},${rule.content},${JSON.stringify(options)}`;seen.has(key)||(result.push(rule),seen.add(key))}),result}}}function RegexReplaceOperator(regex){return{name:"Regex Rename Operator",func:rules=>rules.map(rule=>{for(const{expr:expr,now:now}of regex)rule.content=rule.content.replace(new RegExp(expr,"g"),now).trim();return rule})}}return{"Regex Filter":RegexFilter,"Remove Duplicate Filter":RemoveDuplicateFilter,"Type Filter":TypeFilter,"Regex Replace Operator":RegexReplaceOperator}}(),RULE_PRODUCERS=function(){function QXFilter(){const type="SINGLE",func=rule=>{const UNSUPPORTED=["URL-REGEX","DEST-PORT","SRC-IP","IN-PORT","PROTOCOL"];if(-1!==UNSUPPORTED.indexOf(rule.type))return null;const TRANSFORM={"DOMAIN-KEYWORD":"HOST-KEYWORD","DOMAIN-SUFFIX":"HOST-SUFFIX",DOMAIN:"HOST","IP-CIDR6":"IP6-CIDR"};return`${TRANSFORM[rule.type]||rule.type},${rule.content},SUB-STORE`};return{type:type,func:func}}function SurgeRuleSet(){const type="SINGLE",func=rule=>{let output=`${rule.type},${rule.content}`;return"IP-CIDR"!==rule.type&&"IP-CIDR6"!==rule.type||(output+=rule.options?`,${rule.options[0]}`:""),output};return{type:type,func:func}}function LoonRules(){const type="SINGLE",func=rule=>{const UNSUPPORTED=["DEST-PORT","SRC-IP","IN-PORT","PROTOCOL"];return-1!==UNSUPPORTED.indexOf(rule.type)?null:SurgeRuleSet().func(rule)};return{type:type,func:func}}function ClashRuleProvider(){const type="ALL",func=rules=>{const TRANSFORM={"DEST-PORT":"DST-PORT","SRC-IP":"SRC-IP-CIDR","IN-PORT":"SRC-PORT"},conf={payload:rules.map(rule=>{let output=`${TRANSFORM[rule.type]||rule.type},${rule.content}`;return"IP-CIDR"!==rule.type&&"IP-CIDR6"!==rule.type||(output+=rule.options?`,${rule.options[0]}`:""),output})};return YAML.stringify(conf)};return{type:type,func:func}}return{QX:QXFilter(),Surge:SurgeRuleSet(),Loon:LoonRules(),Clash:ClashRuleProvider()}}();function preprocess(raw){for(const processor of RULE_PREPROCESSORS)try{if(processor.test(raw))return $.info(`Pre-processor [${processor.name}] activated`),processor.parse(raw)}catch(e){$.error(`Parser [${processor.name}] failed\n Reason: ${e}`)}return raw}function parse(raw){raw=preprocess(raw);for(const parser of RULE_PARSERS){let matched;try{matched=parser.test(raw)}catch(err){matched=!1}if(matched)return $.info(`Rule parser [${parser.name}] is activated!`),parser.parse(raw)}}async function process(rules,operators){for(const item of operators){if(!RULE_PROCESSORS[item.type]){console.error(`Unknown operator: ${item.type}!`);continue}const processor=RULE_PROCESSORS[item.type](item.args);$.info(`Applying "${item.type}" with arguments: \n >>> ${JSON.stringify(item.args)||"None"}`),rules=ApplyProcessor(processor,rules)}return rules}function produce(rules,targetPlatform){const producer=RULE_PRODUCERS[targetPlatform];if(!producer)throw new Error(`Target platform: ${targetPlatform} is not supported!`);return void 0===producer.type||"SINGLE"===producer.type?rules.map(rule=>{try{return producer.func(rule)}catch(err){return console.log(`ERROR: cannot produce rule: ${JSON.stringify(rule)}\nReason: ${err}`),""}}).filter(line=>line.length>0).join("\n"):"ALL"===producer.type?producer.func(rules):void 0}return{parse:parse,process:process,produce:produce}}();function getBuiltInRules(){return{AD:{name:"AD",description:"",urls:["https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-surge.txt","https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/BanAD.yaml"]},Global:{name:"Global",description:"",urls:["https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/ProxyGFWlist.yaml","https://raw.githubusercontent.com/DivineEngine/Profiles/master/Quantumult/Filter/Global.list"]},CN:{name:"CN",description:"",urls:["https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Providers/ChinaDomain.yaml","https://raw.githubusercontent.com/DivineEngine/Profiles/master/Quantumult/Filter/China.list"]}}}function ApplyProcessor(process,objs){function ApplyFilter(filter,objs){let selected=FULL(objs.length,!0);try{selected=AND(selected,filter.func(objs))}catch(err){console.log(`Cannot apply filter ${filter.name}\n Reason: ${err}`)}return objs.filter((_,i)=>selected[i])}function ApplyOperator(operator,objs){let output=clone(objs);try{const output_=operator.func(output);output_&&(output=output_)}catch(err){console.log(`Cannot apply operator ${operator.name}! Reason: ${err}`)}return output}return-1!==process.name.indexOf("Filter")?ApplyFilter(process,objs):-1!==process.name.indexOf("Operator")?ApplyOperator(process,objs):void 0}function AND(...args){return args.reduce((a,b)=>a.map((c,i)=>b[i]&&c))}function OR(...args){return args.reduce((a,b)=>a.map((c,i)=>b[i]||c))}function NOT(array){return array.map(c=>!c)}function FULL(length,bool){return[...Array(length).keys()].map(()=>bool)}function clone(object){return JSON.parse(JSON.stringify(object))}function buildRegex(str,...options){return options=options.join(""),str.startsWith("(?i)")?(str=str.substr(4),new RegExp(str,"i"+options)):new RegExp(str,options)}function ENV(){const isQX="undefined"!=typeof $task,isLoon="undefined"!=typeof $loon,isSurge="undefined"!=typeof $httpClient&&!isLoon,isJSBox="function"==typeof require&&"undefined"!=typeof $jsbox,isNode="function"==typeof require&&!isJSBox,isRequest="undefined"!=typeof $request,isScriptable="undefined"!=typeof importModule;return{isQX:isQX,isLoon:isLoon,isSurge:isSurge,isNode:isNode,isJSBox:isJSBox,isRequest:isRequest,isScriptable:isScriptable}}function HTTP(defaultOptions={baseURL:""}){const{isQX:isQX,isLoon:isLoon,isSurge:isSurge,isScriptable:isScriptable,isNode:isNode}=ENV(),methods=["GET","POST","PUT","DELETE","HEAD","OPTIONS","PATCH"],URL_REGEX=/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/;function send(method,options){options="string"==typeof options?{url:options}:options;const baseURL=defaultOptions.baseURL;baseURL&&!URL_REGEX.test(options.url||"")&&(options.url=baseURL?baseURL+options.url:options.url);const timeout=(options={...defaultOptions,...options}).timeout,events={onRequest:()=>{},onResponse:resp=>resp,onTimeout:()=>{},...options.events};let worker,timeoutid;if(events.onRequest(method,options),isQX)worker=$task.fetch({method:method,url:options.url,headers:options.headers,body:options.body});else if(isLoon||isSurge||isNode)worker=new Promise((resolve,reject)=>{const request=isNode?require("request"):$httpClient;request[method.toLowerCase()](options,(err,response,body)=>{err?reject(err):resolve({statusCode:response.status||response.statusCode,headers:response.headers,body:body})})});else if(isScriptable){const request=new Request(options.url);request.method=method,request.headers=options.headers,request.body=options.body,worker=new Promise((resolve,reject)=>{request.loadString().then(body=>{resolve({statusCode:request.response.statusCode,headers:request.response.headers,body:body})}).catch(err=>reject(err))})}const timer=timeout?new Promise((_,reject)=>{timeoutid=setTimeout(()=>(events.onTimeout(),reject(`${method} URL: ${options.url} exceeds the timeout ${timeout} ms`)),timeout)}):null;return(timer?Promise.race([timer,worker]).then(res=>(clearTimeout(timeoutid),res)):worker).then(resp=>events.onResponse(resp))}const http={};return methods.forEach(method=>http[method.toLowerCase()]=options=>send(method,options)),http}function API(name="untitled",debug=!1){const{isQX:isQX,isLoon:isLoon,isSurge:isSurge,isNode:isNode,isJSBox:isJSBox,isScriptable:isScriptable}=ENV();return new class{constructor(name,debug){this.name=name,this.debug=debug,this.http=HTTP(),this.env=ENV(),this.node=(()=>{if(isNode){const fs=require("fs");return{fs:fs}}return null})(),this.initCache();const delay=(t,v)=>new Promise((function(resolve){setTimeout(resolve.bind(null,v),t)}));Promise.prototype.delay=function(t){return this.then((function(v){return delay(t,v)}))}}initCache(){if(isQX&&(this.cache=JSON.parse($prefs.valueForKey(this.name)||"{}")),(isLoon||isSurge)&&(this.cache=JSON.parse($persistentStore.read(this.name)||"{}")),isNode){let fpath="root.json";this.node.fs.existsSync(fpath)||this.node.fs.writeFileSync(fpath,JSON.stringify({}),{flag:"wx"},err=>console.log(err)),this.root={},fpath=`${this.name}.json`,this.node.fs.existsSync(fpath)?this.cache=JSON.parse(this.node.fs.readFileSync(`${this.name}.json`)):(this.node.fs.writeFileSync(fpath,JSON.stringify({}),{flag:"wx"},err=>console.log(err)),this.cache={})}}persistCache(){const data=JSON.stringify(this.cache,null,2);isQX&&$prefs.setValueForKey(data,this.name),(isLoon||isSurge)&&$persistentStore.write(data,this.name),isNode&&(this.node.fs.writeFileSync(`${this.name}.json`,data,{flag:"w"},err=>console.log(err)),this.node.fs.writeFileSync("root.json",JSON.stringify(this.root,null,2),{flag:"w"},err=>console.log(err)))}write(data,key){if(this.log(`SET ${key}`),-1!==key.indexOf("#")){if(key=key.substr(1),isSurge||isLoon)return $persistentStore.write(data,key);if(isQX)return $prefs.setValueForKey(data,key);isNode&&(this.root[key]=data)}else this.cache[key]=data;this.persistCache()}read(key){return this.log(`READ ${key}`),-1===key.indexOf("#")?this.cache[key]:(key=key.substr(1),isSurge||isLoon?$persistentStore.read(key):isQX?$prefs.valueForKey(key):isNode?this.root[key]:void 0)}delete(key){if(this.log(`DELETE ${key}`),-1!==key.indexOf("#")){if(key=key.substr(1),isSurge||isLoon)return $persistentStore.write(null,key);if(isQX)return $prefs.removeValueForKey(key);isNode&&delete this.root[key]}else delete this.cache[key];this.persistCache()}notify(title,subtitle="",content="",options={}){const openURL=options["open-url"],mediaURL=options["media-url"];if(isQX&&$notify(title,subtitle,content,options),isSurge&&$notification.post(title,subtitle,content+`${mediaURL?"\nå¤šåª’ä½“:"+mediaURL:""}`,{url:openURL}),isLoon){let opts={};openURL&&(opts.openUrl=openURL),mediaURL&&(opts.mediaUrl=mediaURL),"{}"===JSON.stringify(opts)?$notification.post(title,subtitle,content):$notification.post(title,subtitle,content,opts)}if(isNode||isScriptable){const content_=content+(openURL?`\nç‚¹å‡»è·³è½¬: ${openURL}`:"")+(mediaURL?`\nå¤šåª’ä½“: ${mediaURL}`:"");if(isJSBox){const push=require("push");push.schedule({title:title,body:(subtitle?subtitle+"\n":"")+content_})}else console.log(`${title}\n${subtitle}\n${content_}\n\n`)}}log(msg){this.debug&&console.log(`[${this.name}] LOG: ${msg}`)}info(msg){console.log(`[${this.name}] INFO: ${msg}`)}error(msg){console.log(`[${this.name}] ERROR: ${msg}`)}wait(millisec){return new Promise(resolve=>setTimeout(resolve,millisec))}done(value={}){isQX||isLoon||isSurge?$done(value):isNode&&!isJSBox&&"undefined"!=typeof $context&&($context.headers=value.headers,$context.statusCode=value.statusCode,$context.body=value.body)}}(name,debug)}function Gist({token:token,key:key}){const http=HTTP({baseURL:"https://api.github.com",headers:{Authorization:`token ${token}`,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.141 Safari/537.36"},events:{onResponse:resp=>/^[45]/.test(String(resp.statusCode))?Promise.reject(`ERROR: ${JSON.parse(resp.body).message}`):resp}});async function locate(){return http.get("/gists").then(response=>{const gists=JSON.parse(response.body);for(let g of gists)if(g.description===key)return g.id;return-1})}this.upload=async function({filename:filename,content:content}){const id=await locate(),files={[filename]:{content:content}};return-1===id?http.post({url:"/gists",body:JSON.stringify({description:key,public:!1,files:files})}):http.patch({url:`/gists/${id}`,body:JSON.stringify({files:files})})},this.download=async function(filename){const id=await locate();if(-1===id)return Promise.reject("æœªæ‰¾åˆ°Gistå¤‡ä»½ï¼");try{const{files:files}=await http.get(`/gists/${id}`).then(resp=>JSON.parse(resp.body)),url=files[filename].raw_url;return await http.get(url).then(resp=>resp.body)}catch(err){return Promise.reject(err)}}}function express({port:port}={port:8081}){const{isNode:isNode}=ENV(),DEFAULT_HEADERS={"Content-Type":"text/plain;charset=UTF-8","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST,GET,OPTIONS,PATCH,PUT,DELETE","Access-Control-Allow-Headers":"Origin, X-Requested-With, Content-Type, Accept"};if(isNode){const express_=require("express"),bodyParser=require("body-parser"),app=express_();return app.use(bodyParser.json({verify:rawBodySaver})),app.use(bodyParser.urlencoded({verify:rawBodySaver,extended:!0})),app.use(bodyParser.raw({verify:rawBodySaver,type:"*/*"})),app.use((req,res,next)=>{res.set(DEFAULT_HEADERS),next()}),app.start=()=>{app.listen(port,()=>{$.log(`Express started on port: ${port}`)})},app}const handlers=[],METHODS_NAMES=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD'","ALL"],dispatch=(request,start=0)=>{let{method:method,url:url,headers:headers,body:body}=request;/json/i.test(headers["Content-Type"])&&(body=JSON.parse(body)),method=method.toUpperCase();const{path:path,query:query}=extractURL(url);let handler=null,i,longestMatchedPattern=0;for(i=start;i<handlers.length;i++)if("ALL"===handlers[i].method||method===handlers[i].method){const{pattern:pattern}=handlers[i];patternMatched(pattern,path)&&pattern.split("/").length>longestMatchedPattern&&(handler=handlers[i],longestMatchedPattern=pattern.split("/").length)}if(handler){const next=()=>{dispatch(method,url,i)},req={method:method,url:url,path:path,query:query,params:extractPathParams(handler.pattern,path),headers:headers,body:body},res=Response(),cb=handler.callback,errFunc=err=>{res.status(500).json({status:"failed",message:`Internal Server Error: ${err}`})};if("AsyncFunction"===cb.constructor.name)cb(req,res,next).catch(errFunc);else try{cb(req,res,next)}catch(err){errFunc(err)}}else{const res=Response();res.status(404).json({status:"failed",message:"ERROR: 404 not found"})}},app={};return METHODS_NAMES.forEach(method=>{app[method.toLowerCase()]=(pattern,callback)=>{handlers.push({method:method,pattern:pattern,callback:callback})}}),app.route=pattern=>{const chainApp={};return METHODS_NAMES.forEach(method=>{chainApp[method.toLowerCase()]=callback=>(handlers.push({method:method,pattern:pattern,callback:callback}),chainApp)}),chainApp},app.start=()=>{dispatch($request)},app;function rawBodySaver(req,res,buf,encoding){buf&&buf.length&&(req.rawBody=buf.toString(encoding||"utf8"))}function Response(){let statusCode=200;const{isQX:isQX,isLoon:isLoon,isSurge:isSurge}=ENV(),headers=DEFAULT_HEADERS,STATUS_CODE_MAP={200:"HTTP/1.1 200 OK",201:"HTTP/1.1 201 Created",302:"HTTP/1.1 302 Found",307:"HTTP/1.1 307 Temporary Redirect",308:"HTTP/1.1 308 Permanent Redirect",404:"HTTP/1.1 404 Not Found",500:"HTTP/1.1 500 Internal Server Error"};return new class{status(code){return statusCode=code,this}send(body=""){const response={status:isQX?STATUS_CODE_MAP[statusCode]:statusCode,body:body,headers:headers};isQX?$done(response):(isLoon||isSurge)&&$done({response:response})}end(){this.send()}html(data){this.set("Content-Type","text/html;charset=UTF-8"),this.send(data)}json(data){this.set("Content-Type","application/json;charset=UTF-8"),this.send(JSON.stringify(data))}set(key,val){return headers[key]=val,this}}}function patternMatched(pattern,path){if(pattern instanceof RegExp&&pattern.test(path))return!0;if("/"===pattern)return!0;if(-1===pattern.indexOf(":")){const spath=path.split("/"),spattern=pattern.split("/");for(let i=0;i<spattern.length;i++)if(spath[i]!==spattern[i])return!1;return!0}return!!extractPathParams(pattern,path)}function extractURL(url){const match=url.match(/https?:\/\/[^\/]+(\/[^?]*)/)||[],path=match[1]||"/",split=url.indexOf("?"),query={};if(-1!==split){let hashes=url.slice(url.indexOf("?")+1).split("&");for(let i=0;i<hashes.length;i++)hash=hashes[i].split("="),query[hash[0]]=hash[1]}return{path:path,query:query}}function extractPathParams(pattern,path){if(-1===pattern.indexOf(":"))return null;{const params={};for(let i=0,j=0;i<pattern.length;i++,j++)if(":"===pattern[i]){let key=[],val=[];for(;"/"!==pattern[++i]&&i<pattern.length;)key.push(pattern[i]);for(;"/"!==path[j]&&j<path.length;)val.push(path[j++]);params[key.join("")]=val.join("")}else if(pattern[i]!==path[j])return null;return params}}}function Base64Code(){const b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",b64tab=function(bin){const t={};let i=0;const l=bin.length;for(;i<l;i++)t[bin.charAt(i)]=i;return t}(b64chars),fromCharCode=String.fromCharCode,cb_utob=function(c){let cc;return c.length<2?(cc=c.charCodeAt(0),cc<128?c:cc<2048?fromCharCode(192|cc>>>6)+fromCharCode(128|63&cc):fromCharCode(224|cc>>>12&15)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|63&cc)):(cc=65536+1024*(c.charCodeAt(0)-55296)+(c.charCodeAt(1)-56320),fromCharCode(240|cc>>>18&7)+fromCharCode(128|cc>>>12&63)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|63&cc))},re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,utob=function(u){return u.replace(re_utob,cb_utob)},cb_encode=function(ccc){const padlen=[0,2,1][ccc.length%3],ord=ccc.charCodeAt(0)<<16|(ccc.length>1?ccc.charCodeAt(1):0)<<8|(ccc.length>2?ccc.charCodeAt(2):0),chars=[b64chars.charAt(ord>>>18),b64chars.charAt(ord>>>12&63),padlen>=2?"=":b64chars.charAt(ord>>>6&63),padlen>=1?"=":b64chars.charAt(63&ord)];return chars.join("")},btoa=function(b){return b.replace(/[\s\S]{1,3}/g,cb_encode)};this.encode=function(u){const isUint8Array="[object Uint8Array]"===Object.prototype.toString.call(u);return isUint8Array?u.toString("base64"):btoa(utob(String(u)))};const uriencode=function(u,urisafe){return urisafe?_encode(String(u)).replace(/[+\/]/g,(function(m0){return"+"===m0?"-":"_"})).replace(/=/g,""):_encode(u)},encodeURI=function(u){return uriencode(u,!0)},re_btou=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,cb_btou=function(cccc){switch(cccc.length){case 4:const cp=(7&cccc.charCodeAt(0))<<18|(63&cccc.charCodeAt(1))<<12|(63&cccc.charCodeAt(2))<<6|63&cccc.charCodeAt(3),offset=cp-65536;return fromCharCode(55296+(offset>>>10))+fromCharCode(56320+(1023&offset));case 3:return fromCharCode((15&cccc.charCodeAt(0))<<12|(63&cccc.charCodeAt(1))<<6|63&cccc.charCodeAt(2));default:return fromCharCode((31&cccc.charCodeAt(0))<<6|63&cccc.charCodeAt(1))}},btou=function(b){return b.replace(re_btou,cb_btou)},cb_decode=function(cccc){const len=cccc.length,padlen=len%4,n=(len>0?b64tab[cccc.charAt(0)]<<18:0)|(len>1?b64tab[cccc.charAt(1)]<<12:0)|(len>2?b64tab[cccc.charAt(2)]<<6:0)|(len>3?b64tab[cccc.charAt(3)]:0),chars=[fromCharCode(n>>>16),fromCharCode(n>>>8&255),fromCharCode(255&n)];return chars.length-=[0,0,2,1][padlen],chars.join("")},_atob=function(a){return a.replace(/\S{1,4}/g,cb_decode)},atob=function(a){return _atob(String(a).replace(/[^A-Za-z0-9\+\/]/g,""))},_decode=function(u){return btou(_atob(u))};this.decode=function(a){return _decode(String(a).replace(/[-_]/g,(function(m0){return"-"===m0?"+":"/"})).replace(/[^A-Za-z0-9\+\/]/g,"")).replace(/&gt;/g,">").replace(/&lt;/g,"<")},this.safeEncode=function(a){return this.encode(a.replace(/\+/g,"-").replace(/\//g,"_"))},this.safeDecode=function(a){return this.decode(a.replace(/-/g,"+").replace(/_/g,"/"))}}var YAML=function(){var errors=[],reference_blocks=[],processing_time=0,regex={regLevel:new RegExp("^([\\s\\-]+)"),invalidLine:new RegExp("^\\-\\-\\-|^\\.\\.\\.|^\\s*#.*|^\\s*$"),dashesString:new RegExp('^\\s*\\"([^\\"]*)\\"\\s*$'),quotesString:new RegExp("^\\s*\\'([^\\']*)\\'\\s*$"),float:new RegExp("^[+-]?[0-9]+\\.[0-9]+(e[+-]?[0-9]+(\\.[0-9]+)?)?$"),integer:new RegExp("^[+-]?[0-9]+$"),array:new RegExp("\\[\\s*(.*)\\s*\\]"),map:new RegExp("\\{\\s*(.*)\\s*\\}"),key_value:new RegExp("([a-z0-9_-][ a-z0-9_-]*):( .+)","i"),single_key_value:new RegExp("^([a-z0-9_-][ a-z0-9_-]*):( .+?)$","i"),key:new RegExp("([a-z0-9_-][ a-z0-9_-]*):( .+)?","i"),item:new RegExp("^-\\s+"),trim:new RegExp("^\\s+|\\s+$"),comment:new RegExp("([^\\'\\\"#]+([\\'\\\"][^\\'\\\"]*[\\'\\\"])*)*(#.*)?")};function Block(lvl){return{parent:null,length:0,level:lvl,lines:[],children:[],addChild:function(obj){this.children.push(obj),obj.parent=this,++this.length}}}function parser(str){var regLevel=regex.regLevel,invalidLine=regex.invalidLine,lines=str.split("\n"),m,level=0,curLevel=0,blocks=[],result=new Block(-1),currentBlock=new Block(0);result.addChild(currentBlock);var levels=[],line="";blocks.push(currentBlock),levels.push(level);for(var i=0,len=lines.length;i<len;++i)if(!(line=lines[i]).match(invalidLine)){if((level=(m=regLevel.exec(line))?m[1].length:0)>curLevel){var oldBlock=currentBlock;currentBlock=new Block(level),oldBlock.addChild(currentBlock),blocks.push(currentBlock),levels.push(level)}else if(level<curLevel){for(var added=!1,k=levels.length-1;k>=0;--k)if(levels[k]==level){currentBlock=new Block(level),blocks.push(currentBlock),levels.push(level),null!=blocks[k].parent&&blocks[k].parent.addChild(currentBlock),added=!0;break}if(!added)return void errors.push("Error: Invalid indentation at line "+i+": "+line)}currentBlock.lines.push(line.replace(regex.trim,"")),curLevel=level}return result}function processValue(val){var m=null;if("true"==(val=val.replace(regex.trim,"")))return!0;if("false"==val)return!1;if(".NaN"==val)return Number.NaN;if("null"==val)return null;if(".inf"==val)return Number.POSITIVE_INFINITY;if("-.inf"==val)return Number.NEGATIVE_INFINITY;if(m=val.match(regex.dashesString))return m[1];if(m=val.match(regex.quotesString))return m[1];if(m=val.match(regex.float))return parseFloat(m[0]);if(m=val.match(regex.integer))return parseInt(m[0]);if(isNaN(m=Date.parse(val))){var res;if(m=val.match(regex.single_key_value))return(res={})[m[1]]=processValue(m[2]),res;if(m=val.match(regex.array)){for(var count=0,c=" ",res=[],content="",str=!1,j=0,lenJ=m[1].length;j<lenJ;++j){if("'"==(c=m[1][j])||'"'==c){if(!1===str){str=c,content+=c;continue}if("'"==c&&"'"==str||'"'==c&&'"'==str){str=!1,content+=c;continue}}else if(!1!==str||"["!=c&&"{"!=c)if(!1!==str||"]"!=c&&"}"!=c){if(!1===str&&0==count&&","==c){res.push(processValue(content)),content="";continue}}else--count;else++count;content+=c}return content.length>0&&res.push(processValue(content)),res}if(m=val.match(regex.map)){for(var count=0,c=" ",res=[],content="",str=!1,j=0,lenJ=m[1].length;j<lenJ;++j){if("'"==(c=m[1][j])||'"'==c){if(!1===str){str=c,content+=c;continue}if("'"==c&&"'"==str||'"'==c&&'"'==str){str=!1,content+=c;continue}}else if(!1!==str||"["!=c&&"{"!=c)if(!1!==str||"]"!=c&&"}"!=c){if(!1===str&&0==count&&","==c){res.push(content),content="";continue}}else--count;else++count;content+=c}content.length>0&&res.push(content);for(var newRes={},j=0,lenJ=res.length;j<lenJ;++j)(m=res[j].match(regex.key_value))&&(newRes[m[1]]=processValue(m[2]));return newRes}return val}return new Date(m)}function processFoldedBlock(block){for(var lines=block.lines,children=block.children,str,chunks=[lines.join(" ")],i=0,len=children.length;i<len;++i)chunks.push(processFoldedBlock(children[i]));return chunks.join("\n")}function processLiteralBlock(block){for(var lines=block.lines,children=block.children,str=lines.join("\n"),i=0,len=children.length;i<len;++i)str+=processLiteralBlock(children[i]);return str}function processBlock(blocks){for(var m=null,res={},lines=null,children=null,currentObj=null,level=-1,processedBlocks=[],isMap=!0,j=0,lenJ=blocks.length;j<lenJ;++j)if(-1==level||level==blocks[j].level){processedBlocks.push(j),level=blocks[j].level,lines=blocks[j].lines,children=blocks[j].children,currentObj=null;for(var i=0,len=lines.length;i<len;++i){var line=lines[i];if(m=line.match(regex.key)){var key=m[1];if("-"==key[0]&&(key=key.replace(regex.item,""),isMap&&(isMap=!1,void 0===res.length&&(res=[])),null!=currentObj&&res.push(currentObj),currentObj={},isMap=!0),void 0!==m[2]){var value=m[2].replace(regex.trim,"");if("&"==value[0]){var nb=processBlock(children);null!=currentObj?currentObj[key]=nb:res[key]=nb,reference_blocks[value.substr(1)]=nb}else if("|"==value[0])null!=currentObj?currentObj[key]=processLiteralBlock(children.shift()):res[key]=processLiteralBlock(children.shift());else if("*"==value[0]){var v=value.substr(1),no={};if(void 0===reference_blocks[v])errors.push("Reference '"+v+"' not found!");else{for(var k in reference_blocks[v])no[k]=reference_blocks[v][k];null!=currentObj?currentObj[key]=no:res[key]=no}}else">"==value[0]?null!=currentObj?currentObj[key]=processFoldedBlock(children.shift()):res[key]=processFoldedBlock(children.shift()):null!=currentObj?currentObj[key]=processValue(value):res[key]=processValue(value)}else null!=currentObj?currentObj[key]=processBlock(children):res[key]=processBlock(children)}else line.match(/^-\s*$/)?(isMap&&(isMap=!1,void 0===res.length&&(res=[])),null!=currentObj&&res.push(currentObj),currentObj={},isMap=!0):(m=line.match(/^-\s*(.*)/))&&(null!=currentObj?currentObj.push(processValue(m[1])):(isMap&&(isMap=!1,void 0===res.length&&(res=[])),res.push(processValue(m[1]))))}null!=currentObj&&(isMap&&(isMap=!1,void 0===res.length&&(res=[])),res.push(currentObj))}for(var j=processedBlocks.length-1;j>=0;--j)blocks.splice.call(blocks,processedBlocks[j],1);return res}function semanticAnalysis(blocks){var res;return processBlock(blocks.children)}function preProcess(src){var m,lines=src.split("\n"),r=regex.comment;for(var i in lines)(m="string"==typeof lines[i]&&lines[i].match(r))&&void 0!==m[3]&&(lines[i]=m[0].substr(0,m[0].length-m[3].length));return lines.join("\n")}function eval(str){errors=[],reference_blocks=[],processing_time=(new Date).getTime();var pre,doc,res=semanticAnalysis(parser(preProcess(str)));return processing_time=(new Date).getTime()-processing_time,res}return{eval:eval,getErrors:function(){return errors},getProcessingTime:function(){return processing_time}}}();